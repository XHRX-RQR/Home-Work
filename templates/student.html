<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â≠¶ÁîüÁ´Ø - ‰Ωú‰∏öÊèê‰∫§Á≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow: auto;
            width: 100%;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: #f0f7ff;
            min-height: 100vh;
            padding: 1vh;
            color: #2c3e50;
            overflow: visible;
            width: 100vw;
            max-width: 100%;
            position: relative;
            margin: 0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
            overflow: visible;
            transform-origin: top center;
            padding: 0 2vw;
        }

        .header {
            background: white;
            padding: 2vh 2vw;
            border-radius: 8px;
            margin-bottom: 1vh;
            border: 1px solid #e3f2fd;
            text-align: center;
        }

        .header h1 {
            color: #1976d2;
            font-size: clamp(16px, 3vh, 28px);
            font-weight: 500;
            margin-bottom: 0.5vh;
        }

        .header p {
            color: #64748b;
            font-size: clamp(12px, 1.8vh, 15px);
        }

        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(100%, 300px), 1fr));
            gap: 1vh;
            overflow: visible;
            margin-bottom: 2vh;
        }

        .student-card {
            background: white;
            padding: 1.5vh 1.5vw;
            border-radius: 8px;
            border: 1px solid #e3f2fd;
            transition: all 0.2s;
            height: fit-content;
        }

        .student-card:hover {
            border-color: #90caf9;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
        }

        .student-info {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e3f2fd;
        }

        .student-name {
            font-size: clamp(14px, 2vh, 18px);
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5vh;
        }

        .student-id {
            color: #94a3b8;
            font-size: 13px;
        }

        .homework-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .homework-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .homework-info {
            flex: 1;
        }

        .homework-subject {
            font-weight: 500;
            color: #1976d2;
            font-size: 14px;
        }

        .homework-title {
            font-size: 13px;
            color: #64748b;
            margin-top: 2px;
        }

        .submit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .submit-btn.not-submitted {
            background: #1976d2;
            color: white;
        }

        .submit-btn.not-submitted:hover {
            background: #1565c0;
        }

        .submit-btn.submitted {
            background: #f1f5f9;
            color: #64748b;
            cursor: default;
            border: 1px solid #e2e8f0;
        }

        .submitted-time {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .no-homework {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-size: 14px;
        }

        .stats {
            background: white;
            padding: 2vh 2vw;
            border-radius: 8px;
            border: 1px solid #e3f2fd;
            text-align: center;
            margin-bottom: 1vh;
        }

        .stats h3 {
            color: #1976d2;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .stats-numbers {
            display: flex;
            justify-content: space-around;
            gap: 16px;
        }

        .stat-item {
            flex: 1;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 500;
            color: #1976d2;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-size: 15px;
        }

        .teacher-link {
            position: fixed;
            bottom: 2vh;
            right: 2vw;
            background: white;
            padding: 1vh 2vw;
            border-radius: 24px;
            text-decoration: none;
            color: #1976d2;
            font-weight: 500;
            font-size: clamp(12px, 1.6vh, 14px);
            border: 1px solid #e3f2fd;
            transition: all 0.2s;
            z-index: 1000;
            max-width: calc(100vw - 4vw);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .teacher-link:hover {
            background: #f0f7ff;
            border-color: #90caf9;
        }

        .admin-link {
            position: fixed;
            bottom: 2vh;
            left: 2vw;
            background: white;
            padding: 1vh 2vw;
            border-radius: 24px;
            text-decoration: none;
            color: #f59e0b;
            font-weight: 500;
            font-size: clamp(12px, 1.6vh, 14px);
            border: 1px solid #fef3c7;
            transition: all 0.2s;
            z-index: 1000;
            max-width: calc(100vw - 4vw);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-link:hover {
            background: #fffbeb;
            border-color: #fbbf24;
        }

        /* ÊëÑÂÉèÂ§¥Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .camera-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }

        .camera-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 95%;
            max-width: 800px;
            max-height: 95vh;
            overflow-y: auto;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .camera-header h3 {
            color: #1976d2;
            font-size: 20px;
            font-weight: 500;
        }

        .close-camera {
            color: #94a3b8;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            line-height: 1;
        }

        .close-camera:hover {
            color: #64748b;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto 16px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        #canvas {
            width: 100%;
            height: auto;
            display: none;
        }

        .camera-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .camera-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .camera-btn.capture {
            background: #10b981;
            color: white;
        }

        .camera-btn.capture:hover {
            background: #059669;
        }

        .camera-btn.retake {
            background: #f59e0b;
            color: white;
        }

        .camera-btn.retake:hover {
            background: #d97706;
        }

        .camera-btn.upload {
            background: #1976d2;
            color: white;
        }

        .camera-btn.upload:hover {
            background: #1565c0;
        }

        .camera-btn.finish {
            background: #8b5cf6;
            color: white;
        }

        .camera-btn.finish:hover {
            background: #7c3aed;
        }

        .camera-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .preview-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            aspect-ratio: 1;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .preview-delete:hover {
            background: rgba(220, 38, 38, 1);
        }

        .image-count-info {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .header {
                padding: 16px;
                margin-bottom: 12px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 13px;
            }

            .student-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .student-card {
                padding: 12px;
            }

            .student-name {
                font-size: 16px;
            }

            .stats {
                padding: 16px;
            }

            .stats-numbers {
                flex-direction: column;
                gap: 12px;
            }

            .stat-number {
                font-size: 24px;
            }

            .teacher-link {
                bottom: 12px;
                right: 12px;
                padding: 10px 16px;
                font-size: 13px;
            }

            .camera-content {
                width: 98%;
                padding: 12px;
            }

            .camera-btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Êô∫ËÉΩ‰Ωú‰∏öÊèê‰∫§Á≥ªÁªü</h1>
            <p>Âú®‰∏ãÊñπÊâæÂà∞ÊÇ®ÁöÑÂßìÂêç,ÁÇπÂáªÂØπÂ∫îÂ≠¶ÁßëÊåâÈíÆÊèê‰∫§‰Ωú‰∏ö</p>
        </div>

        <div id="loading" class="loading">Âä†ËΩΩ‰∏≠...</div>

        <div id="stats" class="stats" style="display: none;">
            <h3>Êèê‰∫§ÁªüËÆ°</h3>
            <div class="stats-numbers">
                <div class="stat-item">
                    <div class="stat-number" id="total-homework">0</div>
                    <div class="stat-label">Â∑≤Â∏ÉÁΩÆ‰Ωú‰∏ö</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-submissions">0</div>
                    <div class="stat-label">ÊÄªÊèê‰∫§Êï∞</div>
                </div>
            </div>
        </div>

        <div id="student-list" class="student-grid"></div>
        <div id="no-homework" class="no-homework" style="display: none;">ÊöÇÊó†Â∏ÉÁΩÆÁöÑ‰Ωú‰∏ö</div>
    </div>

    <a href="/teacher/login" class="teacher-link">üë®‚Äçüè´ ÊïôÂ∏àÁ´Ø</a>
    <a href="/admin/login" class="admin-link">üîê ÁÆ°ÁêÜÁ´Ø</a>

    <!-- ÊëÑÂÉèÂ§¥Ê®°ÊÄÅÊ°Ü -->
    <div id="cameraModal" class="camera-modal">
        <div class="camera-content">
            <div class="camera-header">
                <h3 id="cameraTitle">ÊãçÁÖßÊèê‰∫§‰Ωú‰∏ö</h3>
                <button class="close-camera" onclick="closeCameraModal()">&times;</button>
            </div>
            
            <div class="image-count-info">
                Â∑≤ÊãçÊëÑ: <span id="imageCount">0</span> / <span id="maxImages">5</span> Âº†
            </div>

            <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <div class="camera-controls">
                <button id="captureBtn" class="camera-btn capture" onclick="capturePhoto()">üì∑ ÊãçÁÖß</button>
                <button id="retakeBtn" class="camera-btn retake" onclick="retakePhoto()" style="display: none;">üîÑ ÈáçÊãç</button>
                <button id="uploadBtn" class="camera-btn upload" onclick="uploadPhoto()" style="display: none;">‚úì Á°ÆËÆ§‰∏ä‰º†</button>
                <button id="finishBtn" class="camera-btn finish" onclick="finishSubmission()" disabled>ÂÆåÊàêÊèê‰∫§</button>
            </div>

            <div id="previewImages" class="preview-images"></div>
        </div>
    </div>

    <script>
        let systemConfig = {
            enable_image_upload: false,
            max_images_per_homework: 5
        };

        let currentSubmissionId = null;
        let currentSubject = '';
        let videoStream = null;
        let capturedImageData = null;
        let uploadedImages = [];

        // Âä†ËΩΩÁ≥ªÁªüÈÖçÁΩÆ
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                systemConfig = await response.json();
                document.getElementById('maxImages').textContent = systemConfig.max_images_per_homework;
            } catch (error) {
                console.error('Âä†ËΩΩÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                const students = await response.json();

                document.getElementById('loading').style.display = 'none';

                const studentList = document.getElementById('student-list');
                const noHomework = document.getElementById('no-homework');
                const stats = document.getElementById('stats');
                
                studentList.innerHTML = '';

                let totalHomework = 0;
                let totalSubmissions = 0;
                let hasAnyHomework = false;

                students.forEach((student, index) => {
                    const homeworkStatus = student.homework_status || {};
                    const subjects = Object.keys(homeworkStatus);

                    if (subjects.length > 0) {
                        hasAnyHomework = true;
                    }

                    const card = document.createElement('div');
                    card.className = 'student-card';
                    card.id = `student-${index}`;

                    let homeworkListHtml = '';
                    if (subjects.length === 0) {
                        homeworkListHtml = '<div style="text-align: center; color: #94a3b8; padding: 10px; font-size: 13px;">ÊöÇÊó†Â∏ÉÁΩÆÁöÑ‰Ωú‰∏ö</div>';
                    } else {
                        subjects.forEach(subject => {
                            const homeworks = homeworkStatus[subject];
                            homeworks.forEach(hw => {
                                totalHomework++;
                                if (hw.submitted) totalSubmissions++;

                                const imageInfo = systemConfig.enable_image_upload && hw.submitted ?
                                    `<div class="submitted-time">üì∑ Â∑≤‰∏ä‰º† ${hw.image_count || 0} Âº†ÂõæÁâá</div>` : '';
                                
                                // AIÂÆ°Ê†∏Áä∂ÊÄÅÊòæÁ§∫
                                let aiReviewInfo = '';
                                if (systemConfig.enable_ai_review && hw.submitted && hw.ai_review_status) {
                                    if (hw.ai_review_status === 'pending') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #94a3b8;">‚è≥ Á≠âÂæÖAIÂÆ°Ê†∏</div>';
                                    } else if (hw.ai_review_status === 'reviewing') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #f59e0b;">ü§ñ AIÂà§ÂÆö‰∏≠...</div>';
                                    } else if (hw.ai_review_status === 'approved') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #10b981;">‚úì AIÂÆ°Ê†∏ÈÄöËøá</div>';
                                    } else if (hw.ai_review_status === 'rejected') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #ef4444;">‚úó AIÂÆ°Ê†∏Êú™ÈÄöËøá</div>';
                                    } else if (hw.ai_review_status === 'error') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #94a3b8;">‚ö† AIÂÆ°Ê†∏Â§±Ë¥•</div>';
                                    }
                                }

                                // Âà§Êñ≠ÊòØÂê¶ÂèØ‰ª•ÈáçÊñ∞Êèê‰∫§ÔºöÊú™Êèê‰∫§ Êàñ AIÂÆ°Ê†∏Êú™ÈÄöËøá
                                const canResubmit = !hw.submitted || (hw.ai_review_status === 'rejected');
                                const buttonText = !hw.submitted ? 'Êèê‰∫§' : (hw.ai_review_status === 'rejected' ? 'ÈáçÊñ∞Êèê‰∫§' : 'Â∑≤Êèê‰∫§');
                                const buttonClass = canResubmit ? 'not-submitted' : 'submitted';
                                
                                homeworkListHtml += `
                                    <div class="homework-item">
                                        <div class="homework-info">
                                            <div class="homework-subject">${subject}</div>
                                            <div class="homework-title">${hw.title}</div>
                                            ${hw.submitted ? `<div class="submitted-time">Êèê‰∫§: ${hw.submitted_at}</div>` : ''}
                                            ${imageInfo}
                                            ${aiReviewInfo}
                                        </div>
                                        <button
                                            class="submit-btn ${buttonClass}"
                                            onclick="${canResubmit ? `startSubmission(${student.id}, ${hw.homework_id}, '${subject}', ${hw.submission_id || 'null'})` : ''}"
                                            ${canResubmit ? '' : 'disabled'}
                                        >
                                            ${buttonText}
                                        </button>
                                    </div>
                                `;
                            });
                        });
                    }

                    card.innerHTML = `
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-id">Â≠¶Âè∑: ${student.student_id}</div>
                        </div>
                        <div class="homework-list">
                            ${homeworkListHtml}
                        </div>
                    `;
                    studentList.appendChild(card);
                });

                if (hasAnyHomework) {
                    noHomework.style.display = 'none';
                    stats.style.display = 'block';
                    document.getElementById('total-homework').textContent = totalHomework;
                    document.getElementById('total-submissions').textContent = totalSubmissions;
                } else {
                    noHomework.style.display = 'block';
                    stats.style.display = 'none';
                }

            } catch (error) {
                console.error('Âä†ËΩΩÂ≠¶ÁîüÂàóË°®Â§±Ë¥•:', error);
                alert('Âä†ËΩΩÂ§±Ë¥•,ËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï');
            }
        }

        async function startSubmission(studentId, homeworkId, subject, existingSubmissionId = null) {
            // Â¶ÇÊûúÊòØÈáçÊñ∞Êèê‰∫§ÔºåÂÖàÂà†Èô§ÊóßÁöÑÊèê‰∫§ËÆ∞ÂΩï
            if (existingSubmissionId) {
                if (!confirm(`Ê£ÄÊµãÂà∞‰πãÂâçÁöÑ‰Ωú‰∏öË¢´AIÂà§ÂÆö‰∏∫ÂºÇÂ∏∏ÔºåÊòØÂê¶ÈáçÊñ∞Êèê‰∫§${subject}‰Ωú‰∏öÔºü`)) {
                    return;
                }
                
                try {
                    // Âà†Èô§ÊóßÁöÑÊèê‰∫§ËÆ∞ÂΩïÔºàÂêéÁ´Ø‰ºöËá™Âä®Âà†Èô§Áõ∏ÂÖ≥ÂõæÁâáÔºâ
                    const deleteResponse = await fetch(`/api/delete-submission/${existingSubmissionId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!deleteResponse.ok) {
                        alert('Âà†Èô§ÊóßËÆ∞ÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                        return;
                    }
                } catch (error) {
                    console.error('Âà†Èô§ÊóßËÆ∞ÂΩïÂ§±Ë¥•:', error);
                    alert('Âà†Èô§ÊóßËÆ∞ÂΩïÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                    return;
                }
            }
            
            // Â¶ÇÊûúÂõæÁâá‰∏ä‰º†ÂäüËÉΩÊú™ÂêØÁî®ÔºåÁõ¥Êé•Êèê‰∫§‰Ωú‰∏ö
            if (!systemConfig.enable_image_upload) {
                if (confirm(`Á°ÆÂÆöË¶ÅÊèê‰∫§${subject}‰Ωú‰∏öÂêóÔºü`)) {
                    try {
                        const response = await fetch('/api/create-submission', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                student_id: studentId,
                                homework_id: homeworkId
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // Áõ¥Êé•Á°ÆËÆ§Êèê‰∫§
                            const confirmResponse = await fetch(`/api/confirm-submission/${result.submission_id}`, {
                                method: 'POST'
                            });

                            const confirmResult = await confirmResponse.json();

                            if (confirmResult.success) {
                                alert(confirmResult.message);
                                loadStudents();
                            } else {
                                alert(confirmResult.message);
                            }
                        } else {
                            alert(result.message);
                        }
                    } catch (error) {
                        console.error('Êèê‰∫§‰Ωú‰∏öÂ§±Ë¥•:', error);
                        alert('Êèê‰∫§Â§±Ë¥•,ËØ∑ÈáçËØï');
                    }
                }
                return;
            }

            // ÂõæÁâá‰∏ä‰º†ÂäüËÉΩÂ∑≤ÂêØÁî®ÔºåÈúÄË¶ÅÊãçÁÖß‰∏ä‰º†
            try {
                // ÂàõÂª∫Êèê‰∫§ËÆ∞ÂΩï
                const response = await fetch('/api/create-submission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        homework_id: homeworkId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentSubmissionId = result.submission_id;
                    currentSubject = result.subject;
                    uploadedImages = [];
                    document.getElementById('cameraTitle').textContent = `${result.subject} - ÊãçÁÖßÊèê‰∫§‰Ωú‰∏ö`;
                    document.getElementById('imageCount').textContent = '0';
                    document.getElementById('previewImages').innerHTML = '';
                    document.getElementById('finishBtn').disabled = true;
                    
                    // ÊâìÂºÄÊëÑÂÉèÂ§¥
                    await openCamera();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('ÂºÄÂßãÊèê‰∫§Â§±Ë¥•:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•,ËØ∑ÈáçËØï');
            }
        }

        async function openCamera() {
            try {
                const modal = document.getElementById('cameraModal');
                modal.style.display = 'block';

                // Ê£ÄÊü•ÊµèËßàÂô®ÊòØÂê¶ÊîØÊåÅgetUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÊëÑÂÉèÂ§¥ÂäüËÉΩÔºåËØ∑‰ΩøÁî®Chrome„ÄÅFirefoxÊàñSafariÁ≠âÁé∞‰ª£ÊµèËßàÂô®');
                }

                const video = document.getElementById('video');
                
                // ÂÖàÂ∞ùËØïÂêéÁΩÆÊëÑÂÉèÂ§¥ÔºåÂ¶ÇÊûúÂ§±Ë¥•ÂàôÂ∞ùËØïÂâçÁΩÆÊëÑÂÉèÂ§¥
                let constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                try {
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (err) {
                    console.log('ÂêéÁΩÆÊëÑÂÉèÂ§¥‰∏çÂèØÁî®ÔºåÂ∞ùËØïÂâçÁΩÆÊëÑÂÉèÂ§¥:', err);
                    // Â¶ÇÊûúÂêéÁΩÆÊëÑÂÉèÂ§¥Â§±Ë¥•ÔºåÂ∞ùËØï‰ªªÊÑèÊëÑÂÉèÂ§¥
                    constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                }

                video.srcObject = videoStream;
                
                // Á≠âÂæÖËßÜÈ¢ëÂä†ËΩΩ
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(resolve)
                            .catch(reject);
                    };
                    // ËÆæÁΩÆË∂ÖÊó∂
                    setTimeout(() => reject(new Error('ËßÜÈ¢ëÂä†ËΩΩË∂ÖÊó∂')), 10000);
                });

                console.log('ÊëÑÂÉèÂ§¥Â∑≤ÊàêÂäüÊâìÂºÄ');
            } catch (error) {
                console.error('ÊâìÂºÄÊëÑÂÉèÂ§¥Â§±Ë¥•:', error);
                
                let errorMessage = 'Êó†Ê≥ïËÆøÈóÆÊëÑÂÉèÂ§¥„ÄÇ';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += '\n\nÂéüÂõ†ÔºöÊùÉÈôêË¢´ÊãíÁªù\nËß£ÂÜ≥ÊñπÊ≥ïÔºö\n1. ÁÇπÂáªÂú∞ÂùÄÊ†èÂ∑¶‰æßÁöÑÈîÅÂõæÊ†á\n2. ÂÖÅËÆ∏ÊëÑÂÉèÂ§¥ÊùÉÈôê\n3. Âà∑Êñ∞È°µÈù¢ÈáçËØï';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += '\n\nÂéüÂõ†ÔºöÊú™Ê£ÄÊµãÂà∞ÊëÑÂÉèÂ§¥ËÆæÂ§á\nËß£ÂÜ≥ÊñπÊ≥ïÔºö\n1. Á°Æ‰øùËÆæÂ§áÊúâÊëÑÂÉèÂ§¥\n2. Ê£ÄÊü•ÊëÑÂÉèÂ§¥ÊòØÂê¶Ë¢´ÂÖ∂‰ªñÂ∫îÁî®Âç†Áî®';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += '\n\nÂéüÂõ†ÔºöÊëÑÂÉèÂ§¥Ë¢´ÂÖ∂‰ªñÂ∫îÁî®Âç†Áî®\nËß£ÂÜ≥ÊñπÊ≥ïÔºö\n1. ÂÖ≥Èó≠ÂÖ∂‰ªñ‰ΩøÁî®ÊëÑÂÉèÂ§¥ÁöÑÂ∫îÁî®\n2. ÈáçÂêØÊµèËßàÂô®';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += '\n\nÂéüÂõ†ÔºöÊëÑÂÉèÂ§¥‰∏çÊîØÊåÅËØ∑Ê±ÇÁöÑÂàÜËæ®Áéá\nËß£ÂÜ≥ÊñπÊ≥ïÔºöÁ≥ªÁªüÂ∞ÜËá™Âä®ÈáçËØï';
                } else if (error.name === 'SecurityError') {
                    errorMessage += '\n\nÂéüÂõ†ÔºöÂÆâÂÖ®ÈôêÂà∂\nËß£ÂÜ≥ÊñπÊ≥ïÔºö\n1. Á°Æ‰øù‰ΩøÁî®HTTPSËÆøÈóÆÔºàÊàñlocalhostÔºâ\n2. Ê£ÄÊü•ÊµèËßàÂô®ÂÆâÂÖ®ËÆæÁΩÆ';
                } else {
                    errorMessage += '\n\nÈîôËØØËØ¶ÊÉÖÔºö' + error.message;
                }
                
                alert(errorMessage);
                closeCameraModal();
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            // Á≠âÂæÖËßÜÈ¢ëÂÆåÂÖ®Âä†ËΩΩ
            if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                alert('ËßÜÈ¢ëÂ∞öÊú™ÂáÜÂ§áÂ•ΩÔºåËØ∑Á®çÂêéÂÜçËØï');
                return;
            }

            // Ëé∑ÂèñËßÜÈ¢ëÊµÅÁöÑÂÆûÈôÖÂàÜËæ®Áéá
            let videoWidth = video.videoWidth;
            let videoHeight = video.videoHeight;
            
            console.log('ÂéüÂßãËßÜÈ¢ëÂ∞∫ÂØ∏:', videoWidth, 'x', videoHeight);
            
            // Â¶ÇÊûúÂàÜËæ®ÁéáËøáÈ´òÔºåËøõË°åÁº©Êîæ‰ª•ÊéßÂà∂Êñá‰ª∂Â§ßÂ∞è
            const maxDimension = 1920; // ÊúÄÂ§ßËæπÈïø
            if (videoWidth > maxDimension || videoHeight > maxDimension) {
                const scale = maxDimension / Math.max(videoWidth, videoHeight);
                videoWidth = Math.floor(videoWidth * scale);
                videoHeight = Math.floor(videoHeight * scale);
                console.log('Áº©ÊîæÂêéÂ∞∫ÂØ∏:', videoWidth, 'x', videoHeight);
            }
            
            // ËÆæÁΩÆcanvasÁöÑÂÆûÈôÖÂÉèÁ¥†Â∞∫ÂØ∏
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            
            // Ê∏ÖÁ©∫canvas
            context.clearRect(0, 0, videoWidth, videoHeight);
            
            // ÁªòÂà∂ÂÆåÊï¥ÁöÑËßÜÈ¢ëÂ∏ßÂà∞canvasÔºàÂ¶ÇÊûúÁº©Êîæ‰∫Ü‰ºöËá™Âä®Ë∞ÉÊï¥Ôºâ
            context.drawImage(video, 0, 0, videoWidth, videoHeight);

            // ÂéãÁº©ÂõæÁâáÔºåÁ°Æ‰øùÂ∞è‰∫é5MB
            let quality = 0.85;
            let imageData = canvas.toDataURL('image/jpeg', quality);
            let imageSizeKB = Math.round((imageData.length * 3) / 4 / 1024);
            
            console.log('ÂàùÂßãÂõæÁâáÂ§ßÂ∞è:', imageSizeKB, 'KB, Ë¥®Èáè:', quality);
            
            // Â¶ÇÊûúÂõæÁâáÂ§ß‰∫é5MBÔºåÈÄêÊ≠•Èôç‰ΩéË¥®Èáè
            const maxSizeKB = 5 * 1024; // 5MB
            while (imageSizeKB > maxSizeKB && quality > 0.3) {
                quality -= 0.05;
                imageData = canvas.toDataURL('image/jpeg', quality);
                imageSizeKB = Math.round((imageData.length * 3) / 4 / 1024);
                console.log('ÂéãÁº©‰∏≠... Â§ßÂ∞è:', imageSizeKB, 'KB, Ë¥®Èáè:', quality.toFixed(2));
            }
            
            if (imageSizeKB > maxSizeKB) {
                console.warn('Ë≠¶Âëä: ÂõæÁâá‰ªçÁÑ∂Ë∂ÖËøá5MBÔºåÂΩìÂâçÂ§ßÂ∞è:', imageSizeKB, 'KB');
                alert('ÂõæÁâáËæÉÂ§ßÔºåÂ∑≤Â∞ΩÂäõÂéãÁº©„ÄÇÂ¶ÇÊûú‰∏ä‰º†Â§±Ë¥•ÔºåËØ∑Â∞ùËØïÂú®ÂÖâÁ∫øËæÉÊöóÁöÑÁéØÂ¢ÉÊãçÊëÑ„ÄÇ');
            } else {
                console.log('ÊúÄÁªàÂõæÁâáÂ§ßÂ∞è:', imageSizeKB, 'KB (', (imageSizeKB/1024).toFixed(2), 'MB), Ë¥®Èáè:', quality.toFixed(2));
            }

            capturedImageData = imageData;

            // ÊòæÁ§∫È¢ÑËßà
            video.style.display = 'none';
            canvas.style.display = 'block';

            // ÂàáÊç¢ÊåâÈíÆ
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            document.getElementById('uploadBtn').style.display = 'inline-block';
        }

        function retakePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');

            video.style.display = 'block';
            canvas.style.display = 'none';
            capturedImageData = null;

            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('uploadBtn').style.display = 'none';
        }

        async function uploadPhoto() {
            if (!capturedImageData) {
                alert('ËØ∑ÂÖàÊãçÁÖß');
                return;
            }

            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: currentSubmissionId,
                        image_data: capturedImageData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    uploadedImages.push(result.image);
                    updatePreview();
                    retakePhoto();
                    
                    // ÂêØÁî®ÂÆåÊàêÊåâÈíÆ
                    document.getElementById('finishBtn').disabled = false;

                    // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞‰∏äÈôê
                    if (uploadedImages.length >= systemConfig.max_images_per_homework) {
                        document.getElementById('captureBtn').disabled = true;
                        alert('Â∑≤ËææÂà∞ÊúÄÂ§ß‰∏ä‰º†Êï∞Èáè');
                    }
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('‰∏ä‰º†ÂõæÁâáÂ§±Ë¥•:', error);
                alert('‰∏ä‰º†Â§±Ë¥•,ËØ∑ÈáçËØï');
            }
        }

        function updatePreview() {
            const container = document.getElementById('previewImages');
            container.innerHTML = '';

            uploadedImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <img src="/uploads/${img.filename}" alt="‰Ωú‰∏öÂõæÁâá${index + 1}">
                    <button class="preview-delete" onclick="deleteUploadedImage(${img.id}, ${index})">√ó</button>
                `;
                container.appendChild(div);
            });

            document.getElementById('imageCount').textContent = uploadedImages.length;
        }

        async function deleteUploadedImage(imageId, index) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÂõæÁâáÂêóÔºü')) return;

            try {
                const response = await fetch(`/api/delete-image/${imageId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    uploadedImages.splice(index, 1);
                    updatePreview();
                    
                    // ÈáçÊñ∞ÂêØÁî®ÊãçÁÖßÊåâÈíÆ
                    document.getElementById('captureBtn').disabled = false;
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÂõæÁâá‰∫ÜÔºåÁ¶ÅÁî®ÂÆåÊàêÊåâÈíÆ
                    if (uploadedImages.length === 0) {
                        document.getElementById('finishBtn').disabled = true;
                    }
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Âà†Èô§ÂõæÁâáÂ§±Ë¥•:', error);
                alert('Âà†Èô§Â§±Ë¥•,ËØ∑ÈáçËØï');
            }
        }

        async function finishSubmission() {
            if (uploadedImages.length === 0) {
                alert('ËØ∑Ëá≥Â∞ë‰∏ä‰º†‰∏ÄÂº†‰Ωú‰∏öÂõæÁâá');
                return;
            }

            if (!confirm(`Á°ÆÂÆöË¶ÅÊèê‰∫§${currentSubject}‰Ωú‰∏öÂêóÔºüÂ∑≤‰∏ä‰º†${uploadedImages.length}Âº†ÂõæÁâá„ÄÇ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/confirm-submission/${currentSubmissionId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    closeCameraModal();
                    loadStudents();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('Êèê‰∫§‰Ωú‰∏öÂ§±Ë¥•:', error);
                alert('Êèê‰∫§Â§±Ë¥•,ËØ∑ÈáçËØï');
            }
        }

        function closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            modal.style.display = 'none';

            // ÂÅúÊ≠¢ÊëÑÂÉèÂ§¥
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            // ÈáçÁΩÆÁä∂ÊÄÅ
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            video.style.display = 'block';
            canvas.style.display = 'none';
            capturedImageData = null;
            currentSubmissionId = null;
            uploadedImages = [];

            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('captureBtn').disabled = false;
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('uploadBtn').style.display = 'none';
            document.getElementById('finishBtn').disabled = true;
        }

        // È°µÈù¢Âä†ËΩΩÊó∂ÂÖàÂä†ËΩΩÈÖçÁΩÆÔºåÂÜçÂä†ËΩΩÂ≠¶ÁîüÂàóË°®
        async function initPage() {
            await loadConfig();
            loadStudents();
        }
        
        initPage();

        // ÂÆöÊó∂Âà∑Êñ∞
        setInterval(loadStudents, 30000);
    </script>
</body>
</html>
