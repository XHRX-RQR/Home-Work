<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å­¦ç”Ÿç«¯ - ä½œä¸šæäº¤ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow: auto;
            width: 100%;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: #f0f7ff;
            min-height: 100vh;
            padding: 1vh;
            color: #2c3e50;
            overflow: visible;
            width: 100vw;
            max-width: 100%;
            position: relative;
            margin: 0;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            width: 100%;
            overflow: visible;
            transform-origin: top center;
            padding: 0 2vw;
        }

        .header {
            background: white;
            padding: 2vh 2vw;
            border-radius: 8px;
            margin-bottom: 1vh;
            border: 1px solid #e3f2fd;
            text-align: center;
        }

        .header h1 {
            color: #1976d2;
            font-size: clamp(16px, 3vh, 28px);
            font-weight: 500;
            margin-bottom: 0.5vh;
        }

        .header p {
            color: #64748b;
            font-size: clamp(12px, 1.8vh, 15px);
        }

        .student-grid {
            display: grid;
            /* ä¼˜å…ˆæ˜¾ç¤º3ä¸ªå­¦ç”Ÿä¸€è¡Œï¼Œå®½åº¦ä¸è¶³æ—¶è‡ªåŠ¨å‡å°‘ */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1vh;
            overflow: visible;
            margin-bottom: 2vh;
            align-items: end;  /* å¡ç‰‡åº•éƒ¨å¯¹é½ */
        }
        
        /* å‰©ä½™å­¦ç”Ÿçš„å¯¹é½æ–¹æ¡ˆ */
        /* 1. å¦‚æœåªå‰©1ä¸ªå­¦ç”Ÿï¼Œå æ®1/2å®½åº¦ä¸”ç‹¬å ä¸‹ä¸€è¡Œ */
        .student-grid > :last-child:nth-child(3n+1) {
            grid-column: 1 / 2;  /* å æ®ç¬¬1åˆ—ï¼Œå³1/2çš„å®½åº¦ */
        }
        
        /* 2. å¦‚æœæœ€åå‰©2ä¸ªå­¦ç”Ÿï¼Œå¹³åˆ†ä¸€è¡Œ */
        .student-grid > :nth-last-child(1):nth-child(3n+2),
        .student-grid > :nth-last-child(2):nth-child(3n+3) {
            /* å¹³åˆ†å®½åº¦ */
            flex: 1;
        }

        .student-card {
            background: white;
            padding: 1.5vh 1.5vw;
            border-radius: 8px;
            border: 1px solid #e3f2fd;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            height: 100%;  /* å¡«æ»¡å®¹å™¨é«˜åº¦ */
        }

        .student-card:hover {
            border-color: #90caf9;
            box-shadow: 0 2px 8px rgba(25, 118, 210, 0.1);
        }

        .student-info {
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e3f2fd;
        }

        .student-name {
            font-size: clamp(14px, 2vh, 18px);
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5vh;
        }

        .student-id {
            color: #94a3b8;
            font-size: 13px;
        }

        .homework-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            flex: 1;  /* å æ®å‰©ä½™ç©ºé—´ï¼Œæ¨åŠ¨ä½œä¸šåˆ—è¡¨å‘ä¸‹ */
        }

        .homework-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .homework-info {
            flex: 1;
        }

        .homework-subject {
            font-weight: 500;
            color: #1976d2;
            font-size: 14px;
        }

        .homework-title {
            font-size: 13px;
            color: #64748b;
            margin-top: 2px;
        }

        .submit-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .submit-btn.not-submitted {
            background: #1976d2;
            color: white;
        }

        .submit-btn.not-submitted:hover {
            background: #1565c0;
        }

        .submit-btn.submitted {
            background: #f1f5f9;
            color: #64748b;
            cursor: default;
            border: 1px solid #e2e8f0;
        }

        .submitted-time {
            font-size: 11px;
            color: #64748b;
            margin-top: 4px;
        }

        .no-homework {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-size: 14px;
        }

        .stats {
            background: white;
            padding: 2vh 2vw;
            border-radius: 8px;
            border: 1px solid #e3f2fd;
            text-align: center;
            margin-bottom: 1vh;
        }

        .stats h3 {
            color: #1976d2;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .stats-numbers {
            display: flex;
            justify-content: space-around;
            gap: 16px;
        }

        .stat-item {
            flex: 1;
        }

        .stat-number {
            font-size: 32px;
            font-weight: 500;
            color: #1976d2;
            margin-bottom: 4px;
        }

        .stat-label {
            color: #94a3b8;
            font-size: 13px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-size: 15px;
        }

        .teacher-link {
            position: fixed;
            bottom: 2vh;
            right: 2vw;
            background: white;
            padding: 1vh 2vw;
            border-radius: 24px;
            text-decoration: none;
            color: #1976d2;
            font-weight: 500;
            font-size: clamp(12px, 1.6vh, 14px);
            border: 1px solid #e3f2fd;
            transition: all 0.2s;
            z-index: 1000;
            max-width: calc(100vw - 4vw);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .teacher-link:hover {
            background: #f0f7ff;
            border-color: #90caf9;
        }

        .admin-link {
            position: fixed;
            bottom: 2vh;
            left: 2vw;
            background: white;
            padding: 1vh 2vw;
            border-radius: 24px;
            text-decoration: none;
            color: #f59e0b;
            font-weight: 500;
            font-size: clamp(12px, 1.6vh, 14px);
            border: 1px solid #fef3c7;
            transition: all 0.2s;
            z-index: 1000;
            max-width: calc(100vw - 4vw);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .admin-link:hover {
            background: #fffbeb;
            border-color: #fbbf24;
        }

        /* æ‘„åƒå¤´æ¨¡æ€æ¡†æ ·å¼ */
        .camera-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }

        .camera-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 8px;
            width: 95%;
            max-width: 800px;
            max-height: 95vh;
            overflow-y: auto;
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
        }

        .camera-header h3 {
            color: #1976d2;
            font-size: 20px;
            font-weight: 500;
        }

        .close-camera {
            color: #94a3b8;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            line-height: 1;
        }

        .close-camera:hover {
            color: #64748b;
        }

        .camera-container {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto 16px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
        }

        #video {
            width: 100%;
            height: auto;
            display: block;
        }

        #canvas {
            width: 100%;
            height: auto;
            display: none;
        }

        .camera-controls {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .camera-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .camera-btn.capture {
            background: #10b981;
            color: white;
        }

        .camera-btn.capture:hover {
            background: #059669;
        }

        .camera-btn.retake {
            background: #f59e0b;
            color: white;
        }

        .camera-btn.retake:hover {
            background: #d97706;
        }

        .camera-btn.upload {
            background: #1976d2;
            color: white;
        }

        .camera-btn.upload:hover {
            background: #1565c0;
        }

        .camera-btn.finish {
            background: #8b5cf6;
            color: white;
        }

        .camera-btn.finish:hover {
            background: #7c3aed;
        }

        .camera-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }

        .preview-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .preview-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
            aspect-ratio: 1;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .preview-delete:hover {
            background: rgba(220, 38, 38, 1);
        }

        .image-count-info {
            text-align: center;
            color: #64748b;
            font-size: 14px;
            margin-bottom: 12px;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .header {
                padding: 16px;
                margin-bottom: 12px;
            }

            .header h1 {
                font-size: 18px;
            }

            .header p {
                font-size: 13px;
            }

            .student-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .student-card {
                padding: 12px;
            }

            .student-name {
                font-size: 16px;
            }

            .stats {
                padding: 16px;
            }

            .stats-numbers {
                flex-direction: column;
                gap: 12px;
            }

            .stat-number {
                font-size: 24px;
            }

            .teacher-link {
                bottom: 12px;
                right: 12px;
                padding: 10px 16px;
                font-size: 13px;
            }

            .camera-content {
                width: 98%;
                padding: 12px;
            }

            .camera-btn {
                padding: 10px 16px;
                font-size: 14px;
            }
        }
    </style>
    <script>
        // è‡ªåŠ¨ç¼©æ”¾ä»¥é€‚åº”çª—å£
        function autoScaleContent() {
            const container = document.querySelector('.container');
            if (!container) return;
            
            const windowHeight = window.innerHeight;
            const windowWidth = window.innerWidth;
            const containerHeight = container.scrollHeight;
            const containerWidth = container.scrollWidth;
            
            // å¦‚æœé¡µé¢å†…å®¹é«˜åº¦è¶…è¿‡è§†å£é«˜åº¦ï¼Œä¸è¿›è¡Œç¼©æ”¾
            if (containerHeight > windowHeight - 20 || windowWidth < 768) {
                container.style.transform = 'scale(1)';
                container.style.transformOrigin = 'top center';
                document.body.style.height = 'auto';
                return;
            }
            
            // è®¡ç®—éœ€è¦çš„ç¼©æ”¾æ¯”ä¾‹
            const scaleHeight = (windowHeight - 20) / containerHeight;
            const scaleWidth = (windowWidth - 20) / containerWidth;
            const scale = Math.min(scaleHeight, scaleWidth, 1);
            
            if (scale < 1) {
                container.style.transform = `scale(${scale})`;
                container.style.transformOrigin = 'top center';
                document.body.style.height = `${containerHeight * scale + 20}px`;
            } else {
                container.style.transform = 'scale(1)';
                document.body.style.height = 'auto';
            }
        }
        
        window.addEventListener('load', () => {
            setTimeout(autoScaleContent, 100);
            setTimeout(autoScaleContent, 500);
        });
        window.addEventListener('resize', autoScaleContent);
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½ä½œä¸šæäº¤ç³»ç»Ÿ</h1>
            <p>åœ¨ä¸‹æ–¹æ‰¾åˆ°æ‚¨çš„å§“å,ç‚¹å‡»å¯¹åº”å­¦ç§‘æŒ‰é’®æäº¤ä½œä¸š</p>
        </div>

        <div id="loading" class="loading">åŠ è½½ä¸­...</div>

        <div id="stats" class="stats" style="display: none;">
            <h3>æäº¤ç»Ÿè®¡</h3>
            <div class="stats-numbers">
                <div class="stat-item">
                    <div class="stat-number" id="total-homework">0</div>
                    <div class="stat-label">å·²å¸ƒç½®ä½œä¸š</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-submissions">0</div>
                    <div class="stat-label">æ€»æäº¤æ•°</div>
                </div>
            </div>
        </div>

        <div id="student-list" class="student-grid"></div>
        <div id="no-homework" class="no-homework" style="display: none;">æš‚æ— å¸ƒç½®çš„ä½œä¸š</div>
    </div>

    <a href="/teacher/login" class="teacher-link">ğŸ‘¨â€ğŸ« æ•™å¸ˆç«¯</a>
    <a href="/admin/login" class="admin-link">ğŸ” ç®¡ç†ç«¯</a>
    <a href="/about" class="admin-link" style="left: auto; right: calc(2vw + 150px); background: #f8fafc; color: #64748b; border-color: #e2e8f0;">â„¹ï¸ å…³äº</a>

    <!-- æ‘„åƒå¤´æ¨¡æ€æ¡† -->
    <div id="cameraModal" class="camera-modal">
        <div class="camera-content">
            <div class="camera-header">
                <h3 id="cameraTitle">æ‹ç…§æäº¤ä½œä¸š</h3>
                <button class="close-camera" onclick="closeCameraModal()">&times;</button>
            </div>
            
            <div class="image-count-info">
                å·²æ‹æ‘„: <span id="imageCount">0</span> / <span id="maxImages">5</span> å¼ 
            </div>

            <div class="camera-container">
                <video id="video" autoplay playsinline></video>
                <canvas id="canvas"></canvas>
            </div>

            <div class="camera-controls">
                <button id="captureBtn" class="camera-btn capture" onclick="capturePhoto()">ğŸ“· æ‹ç…§</button>
                <button id="retakeBtn" class="camera-btn retake" onclick="retakePhoto()" style="display: none;">ğŸ”„ é‡æ‹</button>
                <button id="uploadBtn" class="camera-btn upload" onclick="uploadPhoto()" style="display: none;">âœ“ ç¡®è®¤ä¸Šä¼ </button>
                <button id="finishBtn" class="camera-btn finish" onclick="finishSubmission()" disabled>å®Œæˆæäº¤</button>
            </div>

            <div id="previewImages" class="preview-images"></div>
        </div>
    </div>

    <script>
        let systemConfig = {
            enable_image_upload: false,
            max_images_per_homework: 5
        };

        let currentSubmissionId = null;
        let currentSubject = '';
        let videoStream = null;
        let capturedImageData = null;
        let uploadedImages = [];

        // åŠ è½½ç³»ç»Ÿé…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                systemConfig = await response.json();
                document.getElementById('maxImages').textContent = systemConfig.max_images_per_homework;
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                const students = await response.json();

                document.getElementById('loading').style.display = 'none';

                const studentList = document.getElementById('student-list');
                const noHomework = document.getElementById('no-homework');
                const stats = document.getElementById('stats');
                
                studentList.innerHTML = '';

                let totalHomework = 0;
                let totalSubmissions = 0;
                let hasAnyHomework = false;

                students.forEach((student, index) => {
                    const homeworkStatus = student.homework_status || {};
                    const subjects = Object.keys(homeworkStatus);

                    if (subjects.length > 0) {
                        hasAnyHomework = true;
                    }

                    const card = document.createElement('div');
                    card.className = 'student-card';
                    card.id = `student-${index}`;

                    let homeworkListHtml = '';
                    if (subjects.length === 0) {
                        homeworkListHtml = '<div style="text-align: center; color: #94a3b8; padding: 10px; font-size: 13px;">æš‚æ— å¸ƒç½®çš„ä½œä¸š</div>';
                    } else {
                        subjects.forEach(subject => {
                            const homeworks = homeworkStatus[subject];
                            homeworks.forEach(hw => {
                                totalHomework++;
                                if (hw.submitted) totalSubmissions++;

                                const imageInfo = systemConfig.enable_image_upload && hw.submitted ?
                                    `<div class="submitted-time">ğŸ“· å·²ä¸Šä¼  ${hw.image_count || 0} å¼ å›¾ç‰‡</div>` : '';
                                
                                // AIå®¡æ ¸çŠ¶æ€æ˜¾ç¤º
                                let aiReviewInfo = '';
                                if (systemConfig.enable_ai_review && hw.submitted && hw.ai_review_status) {
                                    if (hw.ai_review_status === 'pending') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #94a3b8;">â³ ç­‰å¾…AIå®¡æ ¸</div>';
                                    } else if (hw.ai_review_status === 'reviewing') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #f59e0b;">ğŸ¤– AIåˆ¤å®šä¸­...</div>';
                                    } else if (hw.ai_review_status === 'approved') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #10b981;">âœ“ AIå®¡æ ¸é€šè¿‡</div>';
                                    } else if (hw.ai_review_status === 'rejected') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #ef4444;">âœ— AIå®¡æ ¸æœªé€šè¿‡</div>';
                                    } else if (hw.ai_review_status === 'error') {
                                        aiReviewInfo = '<div class="submitted-time" style="color: #94a3b8;">âš  AIå®¡æ ¸å¤±è´¥</div>';
                                    }
                                }

                                // åˆ¤æ–­æ˜¯å¦å¯ä»¥é‡æ–°æäº¤ï¼šæœªæäº¤ æˆ– AIå®¡æ ¸æœªé€šè¿‡ æˆ– AIå®¡æ ¸å‡ºé”™
                                const canResubmit = !hw.submitted || (hw.ai_review_status === 'rejected') || (hw.ai_review_status === 'error');
                                let buttonText = 'æäº¤';
                                if (hw.submitted) {
                                    if (hw.ai_review_status === 'rejected') {
                                        buttonText = 'é‡æ–°æäº¤';
                                    } else if (hw.ai_review_status === 'error') {
                                        buttonText = 'é‡æ–°æäº¤';
                                    } else {
                                        buttonText = 'å·²æäº¤';
                                    }
                                }
                                const buttonClass = canResubmit ? 'not-submitted' : 'submitted';
                                
                                homeworkListHtml += `
                                    <div class="homework-item">
                                        <div class="homework-info">
                                            <div class="homework-subject">${subject}</div>
                                            <div class="homework-title">${hw.title}</div>
                                            ${hw.submitted ? `<div class="submitted-time">æäº¤: ${hw.submitted_at}</div>` : ''}
                                            ${imageInfo}
                                            ${aiReviewInfo}
                                        </div>
                                        <button
                                            class="submit-btn ${buttonClass}"
                                            onclick="${canResubmit ? `startSubmission(${student.id}, ${hw.homework_id}, '${subject}', ${hw.submission_id || 'null'})` : ''}"
                                            ${canResubmit ? '' : 'disabled'}
                                        >
                                            ${buttonText}
                                        </button>
                                    </div>
                                `;
                            });
                        });
                    }

                    card.innerHTML = `
                        <div class="student-info">
                            <div class="student-name">${student.name}</div>
                            <div class="student-id">å­¦å·: ${student.student_id}</div>
                        </div>
                        <div class="homework-list">
                            ${homeworkListHtml}
                        </div>
                    `;
                    studentList.appendChild(card);
                });

                if (hasAnyHomework) {
                    noHomework.style.display = 'none';
                    stats.style.display = 'block';
                    document.getElementById('total-homework').textContent = totalHomework;
                    document.getElementById('total-submissions').textContent = totalSubmissions;
                } else {
                    noHomework.style.display = 'block';
                    stats.style.display = 'none';
                }
                
                // åŠ è½½å®Œæˆåè§¦å‘è‡ªé€‚åº”ç¼©æ”¾
                setTimeout(autoScaleContent, 100);
                setTimeout(autoScaleContent, 500);

            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥,è¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        async function startSubmission(studentId, homeworkId, subject, existingSubmissionId = null) {
            // å¦‚æœæ˜¯é‡æ–°æäº¤ï¼Œå…ˆåˆ é™¤æ—§çš„æäº¤è®°å½•
            if (existingSubmissionId) {
                if (!confirm(`æ£€æµ‹åˆ°ä¹‹å‰çš„ä½œä¸šå­˜åœ¨é—®é¢˜ï¼ˆAIå®¡æ ¸æœªé€šè¿‡æˆ–å‡ºé”™ï¼‰ï¼Œæ˜¯å¦é‡æ–°æäº¤${subject}ä½œä¸šï¼Ÿ`)) {
                    return;
                }
                
                try {
                    // åˆ é™¤æ—§çš„æäº¤è®°å½•ï¼ˆåç«¯ä¼šè‡ªåŠ¨åˆ é™¤ç›¸å…³å›¾ç‰‡ï¼‰
                    const deleteResponse = await fetch(`/api/delete-submission/${existingSubmissionId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!deleteResponse.ok) {
                        alert('åˆ é™¤æ—§è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                        return;
                    }
                } catch (error) {
                    console.error('åˆ é™¤æ—§è®°å½•å¤±è´¥:', error);
                    alert('åˆ é™¤æ—§è®°å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                    return;
                }
            }
            
            // å¦‚æœå›¾ç‰‡ä¸Šä¼ åŠŸèƒ½æœªå¯ç”¨ï¼Œç›´æ¥æäº¤ä½œä¸š
            if (!systemConfig.enable_image_upload) {
                if (confirm(`ç¡®å®šè¦æäº¤${subject}ä½œä¸šå—ï¼Ÿ`)) {
                    try {
                        const response = await fetch('/api/create-submission', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                student_id: studentId,
                                homework_id: homeworkId
                            })
                        });

                        const result = await response.json();

                        if (result.success) {
                            // ç›´æ¥ç¡®è®¤æäº¤
                            const confirmResponse = await fetch(`/api/confirm-submission/${result.submission_id}`, {
                                method: 'POST'
                            });

                            const confirmResult = await confirmResponse.json();

                            if (confirmResult.success) {
                                alert(confirmResult.message);
                                loadStudents();
                            } else {
                                alert(confirmResult.message);
                            }
                        } else {
                            alert(result.message);
                        }
                    } catch (error) {
                        console.error('æäº¤ä½œä¸šå¤±è´¥:', error);
                        alert('æäº¤å¤±è´¥,è¯·é‡è¯•');
                    }
                }
                return;
            }

            // å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å·²å¯ç”¨ï¼Œéœ€è¦æ‹ç…§ä¸Šä¼ 
            try {
                // åˆ›å»ºæäº¤è®°å½•
                const response = await fetch('/api/create-submission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        student_id: studentId,
                        homework_id: homeworkId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    currentSubmissionId = result.submission_id;
                    currentSubject = result.subject;
                    uploadedImages = [];
                    document.getElementById('cameraTitle').textContent = `${result.subject} - æ‹ç…§æäº¤ä½œä¸š`;
                    document.getElementById('imageCount').textContent = '0';
                    document.getElementById('previewImages').innerHTML = '';
                    document.getElementById('finishBtn').disabled = true;
                    
                    // æ‰“å¼€æ‘„åƒå¤´
                    await openCamera();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('å¼€å§‹æäº¤å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥,è¯·é‡è¯•');
            }
        }

        async function openCamera() {
            try {
                const modal = document.getElementById('cameraModal');
                modal.style.display = 'block';

                // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒgetUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒæ‘„åƒå¤´åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨Chromeã€Firefoxæˆ–Safariç­‰ç°ä»£æµè§ˆå™¨');
                }

                const video = document.getElementById('video');
                
                // åªä½¿ç”¨å‰ç½®æ‘„åƒå¤´
                let constraints = {
                    video: {
                        facingMode: 'user',  // 'user' è¡¨ç¤ºå‰ç½®æ‘„åƒå¤´
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                try {
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (err) {
                    console.log('å‰ç½®æ‘„åƒå¤´ä¸å¯ç”¨ï¼Œå°è¯•ä»»æ„æ‘„åƒå¤´:', err);
                    // å¦‚æœå‰ç½®æ‘„åƒå¤´å¤±è´¥ï¼Œå°è¯•ä»»æ„æ‘„åƒå¤´
                    constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    };
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                }

                video.srcObject = videoStream;
                
                // ç­‰å¾…è§†é¢‘åŠ è½½
                await new Promise((resolve, reject) => {
                    video.onloadedmetadata = () => {
                        video.play()
                            .then(resolve)
                            .catch(reject);
                    };
                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => reject(new Error('è§†é¢‘åŠ è½½è¶…æ—¶')), 10000);
                });

                console.log('æ‘„åƒå¤´å·²æˆåŠŸæ‰“å¼€');
            } catch (error) {
                console.error('æ‰“å¼€æ‘„åƒå¤´å¤±è´¥:', error);
                
                let errorMessage = 'æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += '\n\nåŸå› ï¼šæƒé™è¢«æ‹’ç»\nè§£å†³æ–¹æ³•ï¼š\n1. ç‚¹å‡»åœ°å€æ å·¦ä¾§çš„é”å›¾æ ‡\n2. å…è®¸æ‘„åƒå¤´æƒé™\n3. åˆ·æ–°é¡µé¢é‡è¯•';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += '\n\nåŸå› ï¼šæœªæ£€æµ‹åˆ°æ‘„åƒå¤´è®¾å¤‡\nè§£å†³æ–¹æ³•ï¼š\n1. ç¡®ä¿è®¾å¤‡æœ‰æ‘„åƒå¤´\n2. æ£€æŸ¥æ‘„åƒå¤´æ˜¯å¦è¢«å…¶ä»–åº”ç”¨å ç”¨';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += '\n\nåŸå› ï¼šæ‘„åƒå¤´è¢«å…¶ä»–åº”ç”¨å ç”¨\nè§£å†³æ–¹æ³•ï¼š\n1. å…³é—­å…¶ä»–ä½¿ç”¨æ‘„åƒå¤´çš„åº”ç”¨\n2. é‡å¯æµè§ˆå™¨';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += '\n\nåŸå› ï¼šæ‘„åƒå¤´ä¸æ”¯æŒè¯·æ±‚çš„åˆ†è¾¨ç‡\nè§£å†³æ–¹æ³•ï¼šç³»ç»Ÿå°†è‡ªåŠ¨é‡è¯•';
                } else if (error.name === 'SecurityError') {
                    errorMessage += '\n\nåŸå› ï¼šå®‰å…¨é™åˆ¶\nè§£å†³æ–¹æ³•ï¼š\n1. ç¡®ä¿ä½¿ç”¨HTTPSè®¿é—®ï¼ˆæˆ–localhostï¼‰\n2. æ£€æŸ¥æµè§ˆå™¨å®‰å…¨è®¾ç½®';
                } else {
                    errorMessage += '\n\né”™è¯¯è¯¦æƒ…ï¼š' + error.message;
                }
                
                alert(errorMessage);
                closeCameraModal();
            }
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');

            // ç­‰å¾…è§†é¢‘å®Œå…¨åŠ è½½
            if (video.readyState !== video.HAVE_ENOUGH_DATA) {
                alert('è§†é¢‘å°šæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨åå†è¯•');
                return;
            }

            // è·å–è§†é¢‘æµçš„å®é™…åˆ†è¾¨ç‡
            let videoWidth = video.videoWidth;
            let videoHeight = video.videoHeight;
            
            console.log('åŸå§‹è§†é¢‘å°ºå¯¸:', videoWidth, 'x', videoHeight);
            
            // å¦‚æœåˆ†è¾¨ç‡è¿‡é«˜ï¼Œè¿›è¡Œç¼©æ”¾ä»¥æ§åˆ¶æ–‡ä»¶å¤§å°
            const maxDimension = 1920; // æœ€å¤§è¾¹é•¿
            if (videoWidth > maxDimension || videoHeight > maxDimension) {
                const scale = maxDimension / Math.max(videoWidth, videoHeight);
                videoWidth = Math.floor(videoWidth * scale);
                videoHeight = Math.floor(videoHeight * scale);
                console.log('ç¼©æ”¾åå°ºå¯¸:', videoWidth, 'x', videoHeight);
            }
            
            // è®¾ç½®canvasçš„å®é™…åƒç´ å°ºå¯¸
            canvas.width = videoWidth;
            canvas.height = videoHeight;
            
            // æ¸…ç©ºcanvas
            context.clearRect(0, 0, videoWidth, videoHeight);
            
            // ç»˜åˆ¶å®Œæ•´çš„è§†é¢‘å¸§åˆ°canvasï¼ˆå¦‚æœç¼©æ”¾äº†ä¼šè‡ªåŠ¨è°ƒæ•´ï¼‰
            context.drawImage(video, 0, 0, videoWidth, videoHeight);

            // å‹ç¼©å›¾ç‰‡ï¼Œç¡®ä¿å°äº5MB
            let quality = 0.85;
            let imageData = canvas.toDataURL('image/jpeg', quality);
            let imageSizeKB = Math.round((imageData.length * 3) / 4 / 1024);
            
            console.log('åˆå§‹å›¾ç‰‡å¤§å°:', imageSizeKB, 'KB, è´¨é‡:', quality);
            
            // å¦‚æœå›¾ç‰‡å¤§äº5MBï¼Œé€æ­¥é™ä½è´¨é‡
            const maxSizeKB = 5 * 1024; // 5MB
            while (imageSizeKB > maxSizeKB && quality > 0.3) {
                quality -= 0.05;
                imageData = canvas.toDataURL('image/jpeg', quality);
                imageSizeKB = Math.round((imageData.length * 3) / 4 / 1024);
                console.log('å‹ç¼©ä¸­... å¤§å°:', imageSizeKB, 'KB, è´¨é‡:', quality.toFixed(2));
            }
            
            if (imageSizeKB > maxSizeKB) {
                console.warn('è­¦å‘Š: å›¾ç‰‡ä»ç„¶è¶…è¿‡5MBï¼Œå½“å‰å¤§å°:', imageSizeKB, 'KB');
                alert('å›¾ç‰‡è¾ƒå¤§ï¼Œå·²å°½åŠ›å‹ç¼©ã€‚å¦‚æœä¸Šä¼ å¤±è´¥ï¼Œè¯·å°è¯•åœ¨å…‰çº¿è¾ƒæš—çš„ç¯å¢ƒæ‹æ‘„ã€‚');
            } else {
                console.log('æœ€ç»ˆå›¾ç‰‡å¤§å°:', imageSizeKB, 'KB (', (imageSizeKB/1024).toFixed(2), 'MB), è´¨é‡:', quality.toFixed(2));
            }

            capturedImageData = imageData;

            // æ˜¾ç¤ºé¢„è§ˆ
            video.style.display = 'none';
            canvas.style.display = 'block';

            // åˆ‡æ¢æŒ‰é’®
            document.getElementById('captureBtn').style.display = 'none';
            document.getElementById('retakeBtn').style.display = 'inline-block';
            document.getElementById('uploadBtn').style.display = 'inline-block';
        }

        function retakePhoto() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');

            video.style.display = 'block';
            canvas.style.display = 'none';
            capturedImageData = null;

            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('uploadBtn').style.display = 'none';
        }

        async function uploadPhoto() {
            if (!capturedImageData) {
                alert('è¯·å…ˆæ‹ç…§');
                return;
            }

            try {
                const response = await fetch('/api/upload-image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        submission_id: currentSubmissionId,
                        image_data: capturedImageData
                    })
                });

                const result = await response.json();

                if (result.success) {
                    uploadedImages.push(result.image);
                    updatePreview();
                    retakePhoto();
                    
                    // å¯ç”¨å®ŒæˆæŒ‰é’®
                    document.getElementById('finishBtn').disabled = false;

                    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ä¸Šé™
                    if (uploadedImages.length >= systemConfig.max_images_per_homework) {
                        document.getElementById('captureBtn').disabled = true;
                        alert('å·²è¾¾åˆ°æœ€å¤§ä¸Šä¼ æ•°é‡');
                    }
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('ä¸Šä¼ å›¾ç‰‡å¤±è´¥:', error);
                alert('ä¸Šä¼ å¤±è´¥,è¯·é‡è¯•');
            }
        }

        function updatePreview() {
            const container = document.getElementById('previewImages');
            container.innerHTML = '';

            uploadedImages.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `
                    <img src="/uploads/${img.filename}" alt="ä½œä¸šå›¾ç‰‡${index + 1}">
                    <button class="preview-delete" onclick="deleteUploadedImage(${img.id}, ${index})">Ã—</button>
                `;
                container.appendChild(div);
            });

            document.getElementById('imageCount').textContent = uploadedImages.length;
        }

        async function deleteUploadedImage(imageId, index) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/delete-image/${imageId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    uploadedImages.splice(index, 1);
                    updatePreview();
                    
                    // é‡æ–°å¯ç”¨æ‹ç…§æŒ‰é’®
                    document.getElementById('captureBtn').disabled = false;
                    
                    // å¦‚æœæ²¡æœ‰å›¾ç‰‡äº†ï¼Œç¦ç”¨å®ŒæˆæŒ‰é’®
                    if (uploadedImages.length === 0) {
                        document.getElementById('finishBtn').disabled = true;
                    }
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('åˆ é™¤å›¾ç‰‡å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥,è¯·é‡è¯•');
            }
        }

        async function finishSubmission() {
            if (uploadedImages.length === 0) {
                alert('è¯·è‡³å°‘ä¸Šä¼ ä¸€å¼ ä½œä¸šå›¾ç‰‡');
                return;
            }

            if (!confirm(`ç¡®å®šè¦æäº¤${currentSubject}ä½œä¸šå—ï¼Ÿå·²ä¸Šä¼ ${uploadedImages.length}å¼ å›¾ç‰‡ã€‚`)) {
                return;
            }

            try {
                const response = await fetch(`/api/confirm-submission/${currentSubmissionId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    closeCameraModal();
                    loadStudents();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('æäº¤ä½œä¸šå¤±è´¥:', error);
                alert('æäº¤å¤±è´¥,è¯·é‡è¯•');
            }
        }

        async function closeCameraModal() {
            // å¦‚æœæœ‰æäº¤è®°å½•ä½†æ²¡æœ‰ä¸Šä¼ å›¾ç‰‡ï¼Œæé†’ç”¨æˆ·
            if (currentSubmissionId && uploadedImages.length === 0) {
                if (!confirm('æ‚¨è¿˜æ²¡æœ‰ä¸Šä¼ ä»»ä½•å›¾ç‰‡ï¼Œå…³é—­çª—å£åä½œä¸šå°†ä¸ä¼šè¢«æäº¤ã€‚\n\nç¡®å®šè¦å…³é—­å—ï¼Ÿ')) {
                    return;  // ç”¨æˆ·å–æ¶ˆå…³é—­
                }
            }
            
            const modal = document.getElementById('cameraModal');
            
            // å¦‚æœåˆ›å»ºäº†æäº¤è®°å½•ä½†æ²¡æœ‰ä¸Šä¼ å›¾ç‰‡ï¼Œåˆ é™¤è¯¥æäº¤è®°å½•
            if (currentSubmissionId && uploadedImages.length === 0) {
                try {
                    await fetch(`/api/delete-submission/${currentSubmissionId}`, {
                        method: 'DELETE'
                    });
                    console.log('å·²åˆ é™¤æœªä¸Šä¼ å›¾ç‰‡çš„æäº¤è®°å½•');
                } catch (error) {
                    console.error('åˆ é™¤æäº¤è®°å½•å¤±è´¥:', error);
                }
            }
            
            modal.style.display = 'none';

            // åœæ­¢æ‘„åƒå¤´
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }

            // é‡ç½®çŠ¶æ€
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            video.style.display = 'block';
            canvas.style.display = 'none';
            capturedImageData = null;
            currentSubmissionId = null;
            uploadedImages = [];

            document.getElementById('captureBtn').style.display = 'inline-block';
            document.getElementById('captureBtn').disabled = false;
            document.getElementById('retakeBtn').style.display = 'none';
            document.getElementById('uploadBtn').style.display = 'none';
            document.getElementById('finishBtn').disabled = true;
            
            // åˆ·æ–°å­¦ç”Ÿåˆ—è¡¨ä»¥æ›´æ–°çŠ¶æ€
            loadStudents();
        }

        // é¡µé¢åŠ è½½æ—¶å…ˆåŠ è½½é…ç½®ï¼Œå†åŠ è½½å­¦ç”Ÿåˆ—è¡¨
        async function initPage() {
            await loadConfig();
            loadStudents();
        }
        
        initPage();

        // å®šæ—¶åˆ·æ–°
        setInterval(loadStudents, 30000);
    </script>
</body>
</html>
