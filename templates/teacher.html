<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•™å¸ˆç®¡ç†ç«¯ - ä½œä¸šç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            width: 100%;
            height: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: #f0f7ff;
            min-height: 100vh;
            padding: 1vh;
            color: #2c3e50;
            width: 100vw;
            max-width: 100%;
            position: relative;
            margin: 0;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
            width: 100%;
            padding: 0 2vw;
        }

        .header {
            background: white;
            padding: 2vh 2vw;
            border-radius: 8px;
            border: 1px solid #e3f2fd;
            margin-bottom: 1vh;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1vh;
        }

        .header h1 {
            color: #1976d2;
            font-size: clamp(14px, 2.5vh, 24px);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 1vh 2vw;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: clamp(11px, 1.6vh, 14px);
        }

        .btn-primary {
            background: #1976d2;
            color: white;
        }

        .btn-primary:hover {
            background: #1565c0;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .section {
            background: white;
            padding: 2vh 2vw;
            border-radius: 8px;
            border: 1px solid #e3f2fd;
            margin-bottom: 1vh;
        }

        .section h2 {
            color: #1976d2;
            margin-bottom: 1.5vh;
            padding-bottom: 1vh;
            border-bottom: 1px solid #e3f2fd;
            font-size: clamp(14px, 2vh, 18px);
            font-weight: 500;
        }

        .add-student-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 16px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 6px;
            color: #334155;
            font-weight: 500;
            font-size: 14px;
        }

        .form-group input {
            width: 100%;
            max-width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1976d2;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1vh;
            margin-bottom: 1vh;
        }

        .stat-card {
            background: #e3f2fd;
            color: #1565c0;
            padding: 2vh 1vw;
            border-radius: 8px;
            text-align: center;
        }

        .stat-number {
            font-size: clamp(20px, 4vh, 36px);
            font-weight: 500;
            margin-bottom: 0.5vh;
        }

        .stat-label {
            font-size: clamp(11px, 1.5vh, 14px);
            opacity: 0.9;
        }

        .table-container {
            max-width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            min-width: 500px;
        }

        thead {
            background: #f8fafc;
            color: #475569;
        }

        th, td {
            padding: 12px;
            text-align: left;
            font-size: 14px;
        }

        th {
            font-weight: 500;
        }

        tbody tr {
            border-bottom: 1px solid #f1f5f9;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-submitted {
            background: #dcfce7;
            color: #16a34a;
        }

        .status-pending {
            background: #f1f5f9;
            color: #64748b;
        }

        .status-rejected {
            background: #fef3c7;
            color: #ca8a04;
        }

        .tab-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: #f1f5f9;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 14px;
            color: #64748b;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: #1976d2;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            body {
                padding: 8px;
            }

            .add-student-form {
                grid-template-columns: 1fr;
            }

            .header {
                text-align: center;
                padding: 16px;
            }

            .header h1 {
                font-size: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .section {
                padding: 16px;
                margin-bottom: 12px;
            }

            .section h2 {
                font-size: 16px;
            }

            table {
                font-size: 12px;
                min-width: 400px;
            }

            th, td {
                padding: 6px 4px;
                font-size: 12px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .btn-small {
                padding: 4px 8px;
                font-size: 11px;
            }

            .stat-number {
                font-size: 24px;
            }

            .stat-label {
                font-size: 12px;
            }
        }

        .image-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #dbeafe;
            color: #1e40af;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 6px;
            cursor: pointer;
        }

        .image-badge:hover {
            background: #bfdbfe;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .modal-header h3 {
            color: #1976d2;
            font-size: 18px;
            font-weight: 500;
        }

        .close-modal {
            color: #94a3b8;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            background: none;
            padding: 0;
            line-height: 1;
        }

        .close-modal:hover {
            color: #64748b;
        }

        .modal-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .modal-image-item {
            position: relative;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .modal-image-item img {
            width: 100%;
            height: auto;
            object-fit: contain;
            cursor: pointer;
            display: block;
        }

        .modal-image-item img:hover {
            opacity: 0.8;
        }

        .modal-image-info {
            padding: 8px;
            font-size: 11px;
            color: #64748b;
            background: #f8fafc;
            text-align: center;
        }

        .calendar-section {
            margin-top: 20px;
        }

        .date-selector {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .date-selector label {
            font-weight: 500;
            color: #334155;
        }

        .date-selector input[type="date"] {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            color: #334155;
        }

        .date-selector input[type="date"]:focus {
            outline: none;
            border-color: #1976d2;
        }

        .date-selector select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            color: #334155;
            background: white;
            cursor: pointer;
        }

        .date-selector select:focus {
            outline: none;
            border-color: #1976d2;
        }

        .daily-stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .chart-container {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .chart-container h3 {
            color: #1976d2;
            font-size: 16px;
            margin-bottom: 12px;
            text-align: center;
        }

        .pie-chart-wrapper {
            position: relative;
            height: 250px;
            margin-bottom: 12px;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .stat-box {
            text-align: center;
            padding: 12px;
            border-radius: 6px;
            background: #f8fafc;
        }

        .stat-box.submitted {
            background: #dcfce7;
            color: #16a34a;
        }

        .stat-box.rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        .stat-box.not-submitted {
            background: #f1f5f9;
            color: #64748b;
        }

        .stat-box-value {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .stat-box-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .homework-details-list {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
        }

        .homework-details-list h3 {
            color: #1976d2;
            font-size: 16px;
            margin-bottom: 12px;
        }

        .homework-detail-item {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .homework-detail-item:last-child {
            border-bottom: none;
        }

        .homework-detail-info {
            flex: 1;
        }

        .homework-detail-title {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .homework-detail-stats {
            font-size: 12px;
            color: #64748b;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #94a3b8;
            font-size: 14px;
        }

        .abnormal-badge {
            background: #fee2e2;
            color: #dc2626;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        @media (max-width: 1024px) {
            .daily-stats-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script>
        // è‡ªåŠ¨ç¼©æ”¾ä»¥é€‚åº”çª—å£
        function autoScaleContent() {
            const container = document.querySelector('.container');
            if (!container) return;
            
            const windowHeight = window.innerHeight;
            const windowWidth = window.innerWidth;
            const containerHeight = container.scrollHeight;
            const containerWidth = container.scrollWidth;
            
            // å¦‚æœé¡µé¢å†…å®¹é«˜åº¦è¶…è¿‡è§†å£é«˜åº¦ï¼ˆéœ€è¦æ»šåŠ¨æ¡ï¼‰ï¼Œåˆ™ä¸è¿›è¡Œç¼©æ”¾
            if (containerHeight > windowHeight - 20) {
                container.style.transform = 'scale(1)';
                container.style.transformOrigin = 'top center';
                document.body.style.height = 'auto';
                return;
            }
            
            // è®¡ç®—éœ€è¦çš„ç¼©æ”¾æ¯”ä¾‹
            const scaleHeight = (windowHeight - 20) / containerHeight;
            const scaleWidth = (windowWidth - 20) / containerWidth;
            const scale = Math.min(scaleHeight, scaleWidth, 1); // ä¸æ”¾å¤§ï¼Œåªç¼©å°
            
            if (scale < 1) {
                container.style.transform = `scale(${scale})`;
                container.style.transformOrigin = 'top center';
                document.body.style.height = `${containerHeight * scale + 20}px`;
            } else {
                container.style.transform = 'scale(1)';
                document.body.style.height = 'auto';
            }
        }
        
        // é¡µé¢åŠ è½½å’Œçª—å£å˜åŒ–æ—¶æ‰§è¡Œç¼©æ”¾
        window.addEventListener('load', () => {
            setTimeout(autoScaleContent, 100);
            setTimeout(autoScaleContent, 500);
        });
        window.addEventListener('resize', autoScaleContent);
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ•™å¸ˆç®¡ç†ç«¯ - <span id="teacher-subject"></span></h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='/'">è¿”å›å­¦ç”Ÿç«¯</button>
                <button class="btn btn-secondary" onclick="window.location.href='/about'">â„¹ï¸ å…³äº</button>
                <button class="btn btn-danger" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="total-students">0</div>
                <div class="stat-label">æ€»å­¦ç”Ÿæ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="submitted-students">0</div>
                <div class="stat-label">å·²æäº¤</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unsubmitted-students">0</div>
                <div class="stat-label">æœªæäº¤</div>
            </div>
            <div class="stat-card" id="ai-review-card" style="cursor: pointer; position: relative;" onclick="toggleAIReview()">
                <div class="stat-number" id="ai-review-status" style="font-size: clamp(16px, 3vh, 28px);">--</div>
                <div class="stat-label">AIå¤å®¡çŠ¶æ€</div>
                <div style="font-size: clamp(9px, 1.2vh, 11px); margin-top: 4px; opacity: 0.7;">ç‚¹å‡»åˆ‡æ¢</div>
            </div>
        </div>

        <!-- å¸ƒç½®ä½œä¸š -->
        <div class="section">
            <h2>å¸ƒç½®ä½œä¸š</h2>
            <form class="add-student-form" onsubmit="publishHomework(event)" style="grid-template-columns: 1fr;">
                <div class="form-group">
                    <label for="homework-title">ä½œä¸šæ ‡é¢˜ <span style="color: #ef4444;">*</span></label>
                    <input type="text" id="homework-title" placeholder="ä¾‹å¦‚: ç¬¬ä¸‰ç« ç»ƒä¹ é¢˜" required>
                </div>
                
                <!-- é«˜çº§é…ç½®ï¼ˆå¯æŠ˜å ï¼‰ -->
                <div style="margin: 16px 0;">
                    <button type="button" class="btn btn-secondary" onclick="toggleAdvancedConfig()" style="width: 100%;">
                        <span id="advancedConfigToggle">â–¶</span> é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼‰
                    </button>
                </div>
                
                <div id="advancedConfig" style="display: none; padding: 16px; background: #f8fafc; border-radius: 6px; border: 1px solid #e2e8f0;">
                    <div class="form-group">
                        <label for="max-images">
                            å…è®¸ä¸Šä¼ å›¾ç‰‡æ•°é‡
                            <span style="color: #64748b; font-size: 12px; font-weight: normal;">(1-20å¼ ï¼Œé»˜è®¤5å¼ )</span>
                        </label>
                        <input type="number" id="max-images" min="1" max="20" value="5" placeholder="5">
                    </div>
                    
                    <div class="form-group">
                        <label for="ai-prompt">
                            è‡ªå®šä¹‰AIæ£€æµ‹æç¤ºè¯
                            <span style="color: #64748b; font-size: 12px; font-weight: normal;">(ç•™ç©ºä½¿ç”¨é»˜è®¤æç¤ºè¯)</span>
                        </label>
                        <textarea id="ai-prompt" rows="4" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; font-family: inherit; resize: vertical;" placeholder="ä¾‹å¦‚ï¼šè¯·åˆ¤æ–­è¿™äº›å›¾ç‰‡æ˜¯å¦ä¸ºæ•°å­¦ä½œä¸šï¼Œéœ€è¦åŒ…å«è®¡ç®—é¢˜æˆ–åº”ç”¨é¢˜..."></textarea>
                        <div style="font-size: 12px; color: #64748b; margin-top: 4px;">
                            ğŸ’¡ æç¤ºï¼šè‡ªå®šä¹‰æç¤ºè¯å¯ä»¥è®©AIæ›´å‡†ç¡®åœ°è¯†åˆ«ç‰¹å®šç±»å‹çš„ä½œä¸š
                        </div>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 16px;">
                    <button type="submit" class="btn btn-primary" style="width: 100%;">å¸ƒç½®ä½œä¸š</button>
                </div>
            </form>

            <div class="table-container" style="margin-top: 20px;">
                <h3 style="color: #1976d2; margin-bottom: 12px; font-size: 16px;">å·²å¸ƒç½®çš„ä½œä¸š</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ä½œä¸šæ ‡é¢˜</th>
                            <th>å¸ƒç½®æ—¶é—´</th>
                            <th>æäº¤æƒ…å†µ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="homework-list-body">
                        <tr>
                            <td colspan="4" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- æ—¥å†ç»Ÿè®¡ -->
        <div class="section">
            <h2>ğŸ“… æ—¥å†ç»Ÿè®¡ - æ¯æ—¥ä½œä¸šæäº¤æƒ…å†µ</h2>
            <div class="calendar-section">
                <div class="date-selector">
                    <label for="dateSelect">é€‰æ‹©æ—¥æœŸï¼š</label>
                    <select id="dateSelect" onchange="loadDailyStats()">
                        <option value="">è¯·é€‰æ‹©æ—¥æœŸ</option>
                    </select>
                    <span style="color: #94a3b8; font-size: 13px;">æˆ–</span>
                    <input type="date" id="datePicker" onchange="loadDailyStatsFromPicker()">
                </div>

                <div id="dailyStatsContent" style="display: none;">
                    <div class="daily-stats-container">
                        <div class="chart-container">
                            <h3>æäº¤æƒ…å†µæ€»è§ˆ</h3>
                            <div class="pie-chart-wrapper">
                                <canvas id="dailyPieChart"></canvas>
                            </div>
                            <div class="stats-summary" style="grid-template-columns: repeat(4, 1fr);">
                                <div class="stat-box submitted">
                                    <div class="stat-box-value" id="submittedCount">0</div>
                                    <div class="stat-box-label">æ­£å¸¸æäº¤</div>
                                    <div class="stat-box-label" id="submittedPercent">0%</div>
                                </div>
                                <div class="stat-box" style="background: #fef3c7; color: #ca8a04;">
                                    <div class="stat-box-value" id="rejectedCount">0</div>
                                    <div class="stat-box-label">AIåˆ¤å®šå¼‚å¸¸</div>
                                    <div class="stat-box-label" id="rejectedPercent">0%</div>
                                </div>
                                <div class="stat-box rejected">
                                    <div class="stat-box-value" id="errorCount">0</div>
                                    <div class="stat-box-label">AIå®¡æ ¸å‡ºç°é”™è¯¯</div>
                                    <div class="stat-box-label" id="errorPercent">0%</div>
                                </div>
                                <div class="stat-box not-submitted">
                                    <div class="stat-box-value" id="notSubmittedCount">0</div>
                                    <div class="stat-box-label">æœªæäº¤</div>
                                    <div class="stat-box-label" id="notSubmittedPercent">0%</div>
                                </div>
                            </div>
                            <div style="margin-top: 16px; padding: 12px; background: #f8fafc; border-radius: 6px; font-size: 12px; color: #64748b; line-height: 1.6;">
                                <div style="margin-bottom: 4px;"><strong style="color: #1e293b;">é¢œè‰²è¯´æ˜ï¼š</strong></div>
                                <div>ğŸŸ¢ <strong style="color: #10b981;">æ­£å¸¸æäº¤</strong> - AIå®¡æ ¸é€šè¿‡çš„ä½œä¸š</div>
                                <div>ğŸŸ¡ <strong style="color: #f59e0b;">AIåˆ¤å®šå¼‚å¸¸</strong> - å­¦ç”Ÿæäº¤çš„å›¾ç‰‡è¢«AIè®¤å®šä¸ºä¸åƒä½œä¸š</div>
                                <div>ğŸ”´ <strong style="color: #ef4444;">AIå®¡æ ¸å‡ºç°é”™è¯¯</strong> - AIå®¡æ ¸è¿‡ç¨‹ä¸­å‡ºç°ç³»ç»Ÿé”™è¯¯</div>
                                <div>âšª <strong style="color: #94a3b8;">æœªæäº¤</strong> - å­¦ç”Ÿå°šæœªæäº¤ä½œä¸š</div>
                            </div>
                        </div>

                        <div class="homework-details-list">
                            <h3>ä½œä¸šè¯¦æƒ…</h3>
                            <div id="homeworkDetailsList">
                                <div class="no-data-message">è¯·é€‰æ‹©æ—¥æœŸæŸ¥çœ‹è¯¦æƒ…</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="noDataMessage" class="no-data-message">
                    è¯·é€‰æ‹©æ—¥æœŸæŸ¥çœ‹å½“æ—¥ä½œä¸šæäº¤æƒ…å†µ
                </div>
            </div>
        </div>

        <!-- å­¦ç”Ÿåˆ—è¡¨æ ‡ç­¾é¡µ -->
        <div class="section">
            <h2>å­¦ç”Ÿç®¡ç†</h2>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('all')">å…¨éƒ¨å­¦ç”Ÿ</button>
                <button class="tab-btn" onclick="switchTab('unsubmitted')">æœªæäº¤åå•</button>
                <button class="tab-btn" onclick="switchTab('abnormal')">å¼‚å¸¸ä½œä¸š</button>
            </div>

            <div style="margin-bottom: 15px;">
                <button class="btn btn-danger" onclick="resetSubmissions()">è¿˜åŸä½œä¸šæäº¤æƒ…å†µ</button>
            </div>

            <div id="all-students-tab" class="tab-content active">
                <div class="table-container">
                    <table id="all-students-table">
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>å­¦å·</th>
                                <th>æäº¤æƒ…å†µ</th>
                                <th>ä½œä¸šè¯¦æƒ…</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="all-students-body">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="unsubmitted-students-tab" class="tab-content">
                <div class="table-container">
                    <table id="unsubmitted-students-table">
                        <thead>
                            <tr>
                                <th>å§“å</th>
                                <th>å­¦å·</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="unsubmitted-students-body">
                            <tr>
                                <td colspan="3" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="abnormal-submissions-tab" class="tab-content">
                <div class="table-container">
                    <table id="abnormal-submissions-table">
                        <thead>
                            <tr>
                                <th>å­¦ç”Ÿ</th>
                                <th>ä½œä¸š</th>
                                <th>æäº¤æ—¶é—´</th>
                                <th>AIå®¡æ ¸ç»“æœ</th>
                                <th>å›¾ç‰‡</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="abnormal-submissions-body">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999;">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">ä½œä¸šå›¾ç‰‡</h3>
                <button class="close-modal" onclick="closeImageModal()">&times;</button>
            </div>
            <div id="modalImagesContainer" class="modal-images"></div>
        </div>
    </div>

    <script>
        let systemConfig = {
            enable_image_upload: false
        };
        let currentTeacherInfo = {
            enable_ai_review: false
        };

        // åŠ è½½ç³»ç»Ÿé…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                systemConfig = await response.json();
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // æ›´æ–°AIå¤å®¡çŠ¶æ€æ˜¾ç¤º
        function updateAIReviewDisplay() {
            const statusElement = document.getElementById('ai-review-status');
            const cardElement = document.getElementById('ai-review-card');

            if (!systemConfig.enable_ai_review) {
                // å…¨å±€AIå¤å®¡æœªå¯ç”¨
                statusElement.textContent = 'å…¨å±€ç¦ç”¨';
                cardElement.style.background = '#f1f5f9';
                cardElement.style.color = '#64748b';
                cardElement.style.cursor = 'not-allowed';
                cardElement.onclick = null;
            } else if (currentTeacherInfo.enable_ai_review) {
                // AIå¤å®¡å·²å¯ç”¨
                statusElement.textContent = 'âœ“ å·²å¯ç”¨';
                cardElement.style.background = '#dcfce7';
                cardElement.style.color = '#16a34a';
                cardElement.style.cursor = 'pointer';
                cardElement.onclick = toggleAIReview;
            } else {
                // AIå¤å®¡å·²ç¦ç”¨
                statusElement.textContent = 'âœ— å·²ç¦ç”¨';
                cardElement.style.background = '#fee2e2';
                cardElement.style.color = '#dc2626';
                cardElement.style.cursor = 'pointer';
                cardElement.onclick = toggleAIReview;
            }
        }

        // åˆ‡æ¢AIå¤å®¡è®¾ç½®
        async function toggleAIReview() {
            // å¦‚æœå…¨å±€AIå¤å®¡æœªå¯ç”¨ï¼Œä¸å…è®¸åˆ‡æ¢
            if (!systemConfig.enable_ai_review) {
                alert('ç³»ç»Ÿæœªå¯ç”¨AIå¤å®¡åŠŸèƒ½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨ã€‚');
                return;
            }

            const action = currentTeacherInfo.enable_ai_review ? 'ç¦ç”¨' : 'å¯ç”¨';
            if (!confirm(`ç¡®å®šè¦${action}AIå¤å®¡åŠŸèƒ½å—ï¼Ÿ\n\n${action === 'å¯ç”¨' ? 'AIå°†è‡ªåŠ¨å®¡æ ¸å­¦ç”Ÿæäº¤çš„ä½œä¸šå›¾ç‰‡' : 'AIå°†ä¸å†å®¡æ ¸å­¦ç”Ÿæäº¤çš„ä½œä¸š'}`)) {
                return;
            }

            try {
                const response = await fetch('/api/teacher/toggle-ai-review', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    currentTeacherInfo.enable_ai_review = result.enable_ai_review;
                    updateAIReviewDisplay();
                    alert(result.message);
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('åˆ‡æ¢AIå¤å®¡å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (tab === 'all') {
                document.getElementById('all-students-tab').classList.add('active');
                loadAllStudents();
            } else if (tab === 'unsubmitted') {
                document.getElementById('unsubmitted-students-tab').classList.add('active');
                loadUnsubmittedStudents();
            } else if (tab === 'abnormal') {
                document.getElementById('abnormal-submissions-tab').classList.add('active');
                loadAbnormalSubmissions();
            }
        }

        async function loadAbnormalSubmissions() {
            try {
                const response = await fetch('/api/teacher/abnormal-submissions');
                const submissions = await response.json();

                const tbody = document.getElementById('abnormal-submissions-body');
                tbody.innerHTML = '';

                if (submissions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #4caf50; font-weight: bold;">ğŸ‰ æ²¡æœ‰å¼‚å¸¸ä½œä¸šï¼</td></tr>';
                } else {
                    submissions.forEach(sub => {
                        let statusText = 'AIå®¡æ ¸å¤±è´¥';
                        let statusColor = '#ca8a04';
                        
                        if (sub.ai_review_status === 'rejected') {
                            statusText = 'AIåˆ¤å®šä¸åƒä½œä¸š';
                            statusColor = '#dc2626';
                        } else if (sub.ai_review_status === 'reviewing') {
                            statusText = 'AIåˆ¤å®šä¸­';
                            statusColor = '#f59e0b';
                        } else if (sub.ai_review_status === 'error') {
                            statusText = 'AIå®¡æ ¸å¤±è´¥';
                            statusColor = '#ca8a04';
                        }
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${sub.student_name}<br><span style="font-size: 11px; color: #94a3b8;">${sub.student_id}</span></td>
                            <td>${sub.homework_subject}<br><span style="font-size: 11px; color: #94a3b8;">${sub.homework_title}</span></td>
                            <td style="font-size: 12px;">${sub.submitted_at}</td>
                            <td><span class="abnormal-badge" style="background: ${statusColor === '#dc2626' ? '#fee2e2' : '#fef3c7'}; color: ${statusColor};">${statusText}</span></td>
                            <td>
                                ${sub.image_count > 0 ? `<span class="image-badge" onclick="viewStudentImages(${sub.submission_id}, '${sub.student_name}', '${sub.homework_title}')" title="æŸ¥çœ‹å›¾ç‰‡">ğŸ“· ${sub.image_count}</span>` : '-'}
                            </td>
                            <td>
                                ${sub.ai_review_status !== 'reviewing' ? `
                                    <button class="btn btn-primary btn-small" onclick="approveSubmission(${sub.submission_id})">æ‰¹å‡†</button>
                                    <button class="btn btn-danger btn-small" onclick="rejectSubmission(${sub.submission_id})">æ‰“å›</button>
                                ` : '<span style="color: #f59e0b; font-size: 12px;">åˆ¤å®šä¸­...</span>'}
                                ${sub.ai_review_status === 'error' ?
                                    `<button class="btn btn-secondary btn-small" style="background: #e0e7ff; color: #4338ca; margin-left: 4px;" onclick="retryAIReview(${sub.submission_id})">é‡è¯•AI</button>`
                                    : ''}
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å¼‚å¸¸ä½œä¸šåˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }

        let dailyChartInstance = null;

        async function loadHomeworkDates() {
            try {
                const response = await fetch('/api/teacher/homework-dates');
                const dates = await response.json();

                const select = document.getElementById('dateSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©æ—¥æœŸ</option>';

                if (dates.length === 0) {
                    select.innerHTML = '<option value="">æš‚æ— ä½œä¸šè®°å½•</option>';
                    return;
                }

                dates.forEach(date => {
                    const option = document.createElement('option');
                    option.value = date;
                    option.textContent = date;
                    select.appendChild(option);
                });

                // é»˜è®¤é€‰æ‹©æœ€æ–°æ—¥æœŸ
                if (dates.length > 0) {
                    select.value = dates[0];
                    loadDailyStats();
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥æœŸåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function loadDailyStats() {
            const dateSelect = document.getElementById('dateSelect');
            const date = dateSelect.value;

            if (!date) {
                document.getElementById('dailyStatsContent').style.display = 'none';
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }

            // åŒæ­¥æ—¥æœŸé€‰æ‹©å™¨
            document.getElementById('datePicker').value = date;

            try {
                const response = await fetch(`/api/teacher/daily-homework-stats?date=${date}`);
                const data = await response.json();

                if (data.homeworks.length === 0) {
                    document.getElementById('dailyStatsContent').style.display = 'none';
                    document.getElementById('noDataMessage').style.display = 'block';
                    document.getElementById('noDataMessage').textContent = `${date} å½“å¤©æ²¡æœ‰å¸ƒç½®ä½œä¸š`;
                    return;
                }

                document.getElementById('dailyStatsContent').style.display = 'block';
                document.getElementById('noDataMessage').style.display = 'none';

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                const summary = data.summary;
                document.getElementById('submittedCount').textContent = summary.submitted;
                document.getElementById('rejectedCount').textContent = summary.ai_rejected;
                document.getElementById('errorCount').textContent = summary.ai_error || 0;
                document.getElementById('notSubmittedCount').textContent = summary.not_submitted;
                document.getElementById('submittedPercent').textContent = summary.submitted_percent + '%';
                document.getElementById('rejectedPercent').textContent = summary.ai_rejected_percent + '%';
                document.getElementById('errorPercent').textContent = (summary.ai_error_percent || 0) + '%';
                document.getElementById('notSubmittedPercent').textContent = summary.not_submitted_percent + '%';

                // æ›´æ–°é¥¼çŠ¶å›¾
                const ctx = document.getElementById('dailyPieChart');
                if (dailyChartInstance) {
                    dailyChartInstance.destroy();
                }

                dailyChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['æ­£å¸¸æäº¤', 'AIåˆ¤å®šå¼‚å¸¸', 'AIå®¡æ ¸å‡ºç°é”™è¯¯', 'æœªæäº¤'],
                        datasets: [{
                            data: [summary.submitted, summary.ai_rejected, summary.ai_error || 0, summary.not_submitted],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#94a3b8'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percent = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value} (${percent}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // æ›´æ–°ä½œä¸šè¯¦æƒ…åˆ—è¡¨
                const detailsList = document.getElementById('homeworkDetailsList');
                detailsList.innerHTML = '';

                data.homeworks.forEach(hw => {
                    const item = document.createElement('div');
                    item.className = 'homework-detail-item';
                    
                    // è®¡ç®—ç™¾åˆ†æ¯”
                    const normalSubmitted = hw.submitted - hw.ai_rejected - (hw.ai_error || 0);
                    const submittedPercent = hw.total_students > 0 ? ((normalSubmitted / hw.total_students) * 100).toFixed(1) : 0;
                    const rejectedPercent = hw.total_students > 0 ? ((hw.ai_rejected / hw.total_students) * 100).toFixed(1) : 0;
                    const errorPercent = hw.total_students > 0 ? (((hw.ai_error || 0) / hw.total_students) * 100).toFixed(1) : 0;
                    const notSubmittedPercent = hw.total_students > 0 ? ((hw.not_submitted / hw.total_students) * 100).toFixed(1) : 0;
                    
                    item.innerHTML = `
                        <div class="homework-detail-info">
                            <div class="homework-detail-title">${hw.subject} - ${hw.title}</div>
                            <div class="homework-detail-stats" style="margin-top: 8px;">
                                <span style="color: #64748b;">æ€»å­¦ç”Ÿ: <strong style="color: #1e293b;">${hw.total_students}</strong></span> |
                                <span style="color: #10b981;">æ­£å¸¸æäº¤: <strong>${normalSubmitted}</strong> (${submittedPercent}%)</span> |
                                <span style="color: #f59e0b;">AIåˆ¤å®šå¼‚å¸¸: <strong>${hw.ai_rejected}</strong> (${rejectedPercent}%)</span> |
                                <span style="color: #ef4444;">AIå®¡æ ¸å‡ºç°é”™è¯¯: <strong>${hw.ai_error || 0}</strong> (${errorPercent}%)</span> |
                                <span style="color: #94a3b8;">æœªæäº¤: <strong>${hw.not_submitted}</strong> (${notSubmittedPercent}%)</span>
                            </div>
                        </div>
                    `;
                    detailsList.appendChild(item);
                });

                setTimeout(autoScaleContent, 200);
            } catch (error) {
                console.error('åŠ è½½æ¯æ—¥ç»Ÿè®¡å¤±è´¥:', error);
                alert('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function loadDailyStatsFromPicker() {
            const datePicker = document.getElementById('datePicker');
            const date = datePicker.value;

            if (!date) return;

            // åŒæ­¥ä¸‹æ‹‰é€‰æ‹©å™¨
            const dateSelect = document.getElementById('dateSelect');
            dateSelect.value = date;

            loadDailyStats();
        }

        async function loadAllStudents() {
            try {
                const response = await fetch('/api/teacher/all-students-status');
                const students = await response.json();

                const tbody = document.getElementById('all-students-body');
                tbody.innerHTML = '';

                let totalSubmissions = 0;
                let totalHomework = 0;

                if (students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #999;">æš‚æ— å­¦ç”Ÿ</td></tr>';
                } else {
                    students.forEach(student => {
                        totalHomework += student.total_homework;
                        totalSubmissions += student.submitted_count;

                        // æ„å»ºä½œä¸šæäº¤æƒ…å†µåˆ—è¡¨
                        let homeworkStatus = '';
                        if (student.homework_details && student.homework_details.length > 0) {
                            student.homework_details.forEach(hw => {
                                // æ ¹æ®æäº¤çŠ¶æ€å’ŒAIå®¡æ ¸çŠ¶æ€å†³å®šæ ·å¼
                                let statusClass = 'status-pending';  // é»˜è®¤æœªæäº¤ - ç°è‰²
                                let statusText = 'âœ—';
                                
                                if (hw.submitted) {
                                    // å·²æäº¤
                                    if (hw.ai_review_status === 'rejected') {
                                        // AIå®¡æ ¸æœªé€šè¿‡ - é»„è‰²
                                        statusClass = 'status-rejected';
                                    } else if (hw.ai_review_status === 'approved' || hw.ai_review_status === 'pending' || hw.ai_review_status === 'reviewing') {
                                        // AIå®¡æ ¸é€šè¿‡æˆ–åˆ¤å®šä¸­ - ç»¿è‰²
                                        statusClass = 'status-submitted';
                                    } else if (hw.ai_review_status === 'error') {
                                        // AIå®¡æ ¸å‡ºé”™ - é»„è‰²
                                        statusClass = 'status-rejected';
                                    } else {
                                        // æ— AIå®¡æ ¸æˆ–æœªçŸ¥çŠ¶æ€ - ç»¿è‰²
                                        statusClass = 'status-submitted';
                                    }
                                    statusText = 'âœ“';
                                }
                                
                                const imageInfo = systemConfig.enable_image_upload && hw.submitted && hw.image_count > 0 ?
                                    `<span class="image-badge" onclick="viewStudentImages(${hw.submission_id}, '${student.name}', '${hw.title}')" title="æŸ¥çœ‹å›¾ç‰‡">ğŸ“· ${hw.image_count}</span>` : '';
                                
                                // AIå®¡æ ¸çŠ¶æ€æ ‡è®°
                                let aiReviewBadge = '';
                                if (systemConfig.enable_ai_review && hw.submitted && hw.ai_review_status) {
                                    if (hw.ai_review_status === 'rejected') {
                                        aiReviewBadge = `<span class="image-badge" style="background: #fee2e2; color: #dc2626; cursor: pointer;" onclick="handleAIReview(${hw.submission_id}, '${student.name}', '${hw.title}')" title="AIå®¡æ ¸æœªé€šè¿‡ï¼Œç‚¹å‡»å¤„ç†">âš </span>`;
                                    } else if (hw.ai_review_status === 'error') {
                                        aiReviewBadge = `<span class="image-badge" style="background: #fef3c7; color: #ca8a04; cursor: pointer;" onclick="handleAIReview(${hw.submission_id}, '${student.name}', '${hw.title}')" title="AIå®¡æ ¸å¤±è´¥ï¼Œç‚¹å‡»å¤„ç†">âš </span>`;
                                    } else if (hw.ai_review_status === 'pending') {
                                        aiReviewBadge = '<span class="image-badge" style="background: #f1f5f9; color: #64748b;" title="ç­‰å¾…AIå®¡æ ¸">â³</span>';
                                    } else if (hw.ai_review_status === 'reviewing') {
                                        aiReviewBadge = '<span class="image-badge" style="background: #fef3c7; color: #f59e0b;" title="AIåˆ¤å®šä¸­">ğŸ¤–</span>';
                                    }
                                }
                                
                                homeworkStatus += `<span class="status-badge ${statusClass}" title="${hw.title}">${hw.title.substring(0, 8)}${hw.title.length > 8 ? '...' : ''}: ${statusText}${imageInfo}${aiReviewBadge}</span> `;
                            });
                        } else {
                            homeworkStatus = '-';
                        }

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${student.name}</td>
                            <td>${student.student_id}</td>
                            <td>${student.submitted_count} / ${student.total_homework}</td>
                            <td style="font-size: 12px;">${homeworkStatus}</td>
                            <td>-</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                document.getElementById('total-students').textContent = students.length;
                document.getElementById('submitted-students').textContent = totalSubmissions;
                document.getElementById('unsubmitted-students').textContent = totalHomework - totalSubmissions;

                // æ•°æ®åŠ è½½åé‡æ–°è®¡ç®—ç¼©æ”¾
                setTimeout(autoScaleContent, 200);

            } catch (error) {
                console.error('åŠ è½½å­¦ç”Ÿåˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }

        async function loadUnsubmittedStudents() {
            try {
                const response = await fetch('/api/teacher/unsubmitted-students');
                const students = await response.json();

                const tbody = document.getElementById('unsubmitted-students-body');
                tbody.innerHTML = '';

                if (students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #4caf50; font-weight: bold;">ğŸ‰ æ‰€æœ‰å­¦ç”Ÿéƒ½å·²æäº¤ä½œä¸šï¼</td></tr>';
                } else {
                    students.forEach(student => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${student.name}</td>
                            <td>${student.student_id}</td>
                            <td>-</td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æœªæäº¤å­¦ç”Ÿåˆ—è¡¨å¤±è´¥:', error);
                alert('åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        }

        async function deleteStudent(studentId) {
            alert('æ­¤åŠŸèƒ½å·²ç¦ç”¨ï¼Œè¯·ä½¿ç”¨ç®¡ç†ç«¯åˆ é™¤å­¦ç”Ÿ');
        }

        async function resetSubmissions() {
            if (confirm('ç¡®å®šè¦è¿˜åŸæ‰€æœ‰ä½œä¸šæäº¤è®°å½•å—ï¼Ÿæ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿçš„æäº¤çŠ¶æ€ï¼')) {
                try {
                    const response = await fetch('/api/teacher/reset-submissions', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        loadAllStudents();
                        loadUnsubmittedStudents();
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('è¿˜åŸå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        async function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                try {
                    const response = await fetch('/api/teacher/logout', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (result.success) {
                        window.location.href = '/teacher/login';
                    }
                } catch (error) {
                    console.error('é€€å‡ºå¤±è´¥:', error);
                    window.location.href = '/teacher/login';
                }
            }
        }

        function toggleAdvancedConfig() {
            const config = document.getElementById('advancedConfig');
            const toggle = document.getElementById('advancedConfigToggle');
            
            if (config.style.display === 'none') {
                config.style.display = 'block';
                toggle.textContent = 'â–¼';
            } else {
                config.style.display = 'none';
                toggle.textContent = 'â–¶';
            }
            
            setTimeout(autoScaleContent, 100);
        }

        async function publishHomework(event) {
            event.preventDefault();

            const title = document.getElementById('homework-title').value;
            const maxImages = document.getElementById('max-images').value;
            const aiPrompt = document.getElementById('ai-prompt').value;

            try {
                const response = await fetch('/api/teacher/publish-homework', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title,
                        max_images: maxImages,
                        ai_prompt: aiPrompt
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    document.getElementById('homework-title').value = '';
                    document.getElementById('max-images').value = '5';
                    document.getElementById('ai-prompt').value = '';
                    document.getElementById('advancedConfig').style.display = 'none';
                    document.getElementById('advancedConfigToggle').textContent = 'â–¶';
                    loadHomeworks();
                    loadAllStudents();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('å¸ƒç½®ä½œä¸šå¤±è´¥:', error);
                alert('å¸ƒç½®å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function exportHomework(homeworkId, format) {
            window.location.href = `/api/teacher/export-homework/${homeworkId}?format=${format}`;
        }

        function showExportMenu(homeworkId, title) {
            const formats = ['Excel', 'CSV', 'JSON', 'TXT'];
            const formatValues = ['excel', 'csv', 'json', 'txt'];
            
            const message = `é€‰æ‹©å¯¼å‡ºæ ¼å¼ï¼š\n\n${formats.map((f, i) => `${i + 1}. ${f}`).join('\n')}`;
            const choice = prompt(message, '1');
            
            if (choice) {
                const index = parseInt(choice) - 1;
                if (index >= 0 && index < formats.length) {
                    exportHomework(homeworkId, formatValues[index]);
                }
            }
        }

        async function loadHomeworks() {
            try {
                const response = await fetch('/api/teacher/homeworks');
                const homeworks = await response.json();

                const tbody = document.getElementById('homework-list-body');
                tbody.innerHTML = '';

                if (homeworks.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999;">è¿˜æœªå¸ƒç½®ä»»ä½•ä½œä¸š</td></tr>';
                } else {
                    homeworks.forEach(hw => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${hw.title}</td>
                            <td>${hw.created_at}</td>
                            <td>${hw.submitted_count} / ${hw.total_students}</td>
                            <td>
                                <button class="btn btn-secondary btn-small" onclick="showExportMenu(${hw.id}, '${hw.title}')">å¯¼å‡º</button>
                                <button class="btn btn-danger btn-small" onclick="deleteHomework(${hw.id})">åˆ é™¤</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                // æ•°æ®åŠ è½½åé‡æ–°è®¡ç®—ç¼©æ”¾
                setTimeout(autoScaleContent, 200);

            } catch (error) {
                console.error('åŠ è½½ä½œä¸šåˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function deleteHomework(homeworkId) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä½œä¸šå—ï¼Ÿç›¸å…³çš„æäº¤è®°å½•ä¹Ÿä¼šè¢«åˆ é™¤ã€‚')) {
                try {
                    const response = await fetch(`/api/teacher/delete-homework/${homeworkId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(result.message);
                        loadHomeworks();
                        loadAllStudents();
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('åˆ é™¤ä½œä¸šå¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
        }

        async function viewStudentImages(submissionId, studentName, homeworkTitle) {
            try {
                const response = await fetch(`/api/submission-images/${submissionId}`);
                const images = await response.json();

                document.getElementById('modalTitle').textContent = `${studentName} - ${homeworkTitle}`;
                
                const container = document.getElementById('modalImagesContainer');
                container.innerHTML = '';

                if (images.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #94a3b8; grid-column: 1/-1;">æš‚æ— å›¾ç‰‡</p>';
                } else {
                    images.forEach(img => {
                        const div = document.createElement('div');
                        div.className = 'modal-image-item';
                        div.innerHTML = `
                            <img src="${img.url}" alt="${img.original_filename}" onclick="window.open('${img.url}', '_blank')" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾">
                            <div class="modal-image-info">${img.uploaded_at}</div>
                        `;
                        container.appendChild(div);
                    });
                }

                document.getElementById('imageModal').style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                alert('åŠ è½½å›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('imageModal');
            if (event.target === modal) {
                closeImageModal();
            }
        }

        async function handleAIReview(submissionId, studentName, homeworkTitle) {
            const message = `å­¦ç”Ÿï¼š${studentName}
ä½œä¸šï¼š${homeworkTitle}

AIåˆ¤å®šè¯¥ä½œä¸šå¯èƒ½ä¸æ˜¯çœŸå®ä½œä¸šã€‚

è¯·é€‰æ‹©å¤„ç†æ–¹å¼ï¼š`;
            
            if (confirm(message + '\n\nç‚¹å‡»"ç¡®å®š"æ‰¹å‡†è¯¥ä½œä¸š\nç‚¹å‡»"å–æ¶ˆ"æŸ¥çœ‹å›¾ç‰‡åå†å†³å®š')) {
                // æ‰¹å‡†ä½œä¸š
                try {
                    const response = await fetch(`/api/teacher/override-ai-review/${submissionId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ action: 'approve' })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('å·²æ‰¹å‡†è¯¥ä½œä¸š');
                        loadAllStudents();
                    } else {
                        alert(result.message);
                    }
                } catch (error) {
                    console.error('æ‰¹å‡†ä½œä¸šå¤±è´¥:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } else {
                // æŸ¥çœ‹å›¾ç‰‡
                viewStudentImages(submissionId, studentName, homeworkTitle);
                
                // åœ¨æ¨¡æ€æ¡†ä¸­æ·»åŠ æ“ä½œæŒ‰é’®
                setTimeout(() => {
                    const modalContent = document.querySelector('.modal-content');
                    let actionButtons = document.getElementById('aiReviewActions');
                    
                    if (!actionButtons) {
                        actionButtons = document.createElement('div');
                        actionButtons.id = 'aiReviewActions';
                        actionButtons.style.cssText = 'margin-top: 16px; display: flex; gap: 12px; justify-content: center;';
                        actionButtons.innerHTML = `
                            <button class="btn btn-primary" onclick="approveSubmission(${submissionId})">âœ“ æ‰¹å‡†ä½œä¸š</button>
                            <button class="btn btn-danger" onclick="rejectSubmission(${submissionId})">âœ— æ‰“å›ä½œä¸š</button>
                        `;
                        modalContent.appendChild(actionButtons);
                    }
                }, 100);
            }
        }

        async function approveSubmission(submissionId) {
            if (!confirm('ç¡®å®šè¦æ‰¹å‡†è¿™ä¸ªä½œä¸šå—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/teacher/override-ai-review/${submissionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'approve' })
                });

                const result = await response.json();

                if (result.success) {
                    alert('å·²æ‰¹å‡†è¯¥ä½œä¸š');
                    closeImageModal();
                    loadAllStudents();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('æ‰¹å‡†ä½œä¸šå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function rejectSubmission(submissionId) {
            if (!confirm('ç¡®å®šè¦æ‰“å›è¿™ä¸ªä½œä¸šå—ï¼Ÿ\n\nä½œä¸šè®°å½•å’Œå›¾ç‰‡å°†è¢«åˆ é™¤ï¼Œå­¦ç”Ÿéœ€è¦é‡æ–°æäº¤ã€‚')) return;

            try {
                const response = await fetch(`/api/teacher/override-ai-review/${submissionId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ action: 'reject_and_delete' })
                });

                const result = await response.json();

                if (result.success) {
                    alert('å·²æ‰“å›è¯¥ä½œä¸š');
                    closeImageModal();
                    loadAllStudents();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('æ‰“å›ä½œä¸šå¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function retryAIReview(submissionId) {
            if (!confirm('ç¡®å®šè¦é‡æ–°è®©AIå®¡æ ¸è¿™ä¸ªä½œä¸šå—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/teacher/retry-ai-review/${submissionId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    // åˆ·æ–°åˆ—è¡¨
                    loadAbnormalSubmissions();
                } else {
                    alert(result.message);
                }
            } catch (error) {
                console.error('é‡è¯•AIå®¡æ ¸å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åˆå§‹åŒ–åŠ è½½
        async function initPage() {
            await loadConfig();
            loadAllStudents();
            loadHomeworks();
            loadHomeworkDates();
        }

        initPage();

        // ä» URLè·å–å­¦ç§‘ä¿¡æ¯å¹¶æ˜¾ç¤º
        fetch('/api/teacher/current-info')
            .then(res => res.json())
            .then(data => {
                if (data.subject) {
                    document.getElementById('teacher-subject').textContent = data.subject;
                }
                if (data.enable_ai_review !== undefined) {
                    currentTeacherInfo.enable_ai_review = data.enable_ai_review;
                    updateAIReviewDisplay();
                }
            })
            .catch(err => console.error('è·å–æ•™å¸ˆä¿¡æ¯å¤±è´¥:', err));

        setInterval(() => {
            loadAllStudents();
            loadHomeworks();
            loadHomeworkDates();
            if (document.getElementById('unsubmitted-students-tab').classList.contains('active')) {
                loadUnsubmittedStudents();
            }
            if (document.getElementById('abnormal-submissions-tab').classList.contains('active')) {
                loadAbnormalSubmissions();
            }
        }, 30000);
    </script>
</body>
</html>
